{{ define "views/plant.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "common/header.html" .}}
<script src="/static/js/growth-history.js"></script>
{{ template "common/header2.html" .}}
<div class="container">
    <!-- Page Title -->
    <div class="text-center mb-5">
        <h1 class="display-4 text-primary">{{ .plant.Name }}</h1>
        <p class="text-muted">{{ .plant.Description }}</p>
    </div>

    <div class="text-center mb-5">
        <div class="row g-4">
            <!-- Latest Image Section -->
            <div class="col-md-6">
                <div class="card">
                    <img
                            src="{{ .plant.LatestImage.ImagePath }}"
                            class="card-img-top"
                            alt="{{ .plant.LatestImage.ImageDescription }}"
                            style="max-height: 450px; object-fit: contain;"
                    >
                </div>
            </div>

            <!-- Plant Details Section -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body text-start">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title text-primary">{{ .lcl.plant_details }}</h5>
                            {{ if .loggedIn }}
                            <div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changeStatusModal">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-danger" id="deletePlantButton">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            {{ end }}
                        </div>
                        <input type="hidden" id="strainName" value="{{ .plant.StrainName }}">
                        <input type="hidden" id="breederName" value="{{ .plant.BreederName }}">
                        <input type="hidden" id="currentDay" value="{{ .plant.CurrentDay }}">
                        <input type="hidden" id="currentWeek" value="{{ .plant.CurrentWeek }}">

                        <ul class="list-unstyled">
                            {{ $plbl := index $.lcl (print (lower .plant.Status) "_label") }}
                            <li><strong>{{ .lcl.title_status }}:</strong> <span id="plantStatusText">{{ if $plbl }}{{ $plbl }}{{ else }}{{ .plant.Status }}{{ end }}</span></li>
                            <li><strong>{{ .lcl.title_strain }}:</strong>
                                {{ if ne .plant.StrainUrl "" }}
                                    <a href="{{ .plant.StrainUrl }}" target="_blank">{{ .plant.StrainName }}</a> (by {{ .plant.BreederName }})
                                {{ else }}
                                    {{ .plant.StrainName }} (by {{ .plant.BreederName }})
                                {{ end }}
                                </li>

                            <!-- Conditional: If Plant is a Clone -->
                            {{ if .plant.IsClone }}
                            {{ if ne .plant.ParentID 0 }}
                            <li><strong>{{ .lcl.clone_of }}:</strong> <a href="/plant/{{ .plant.ParentID }}">{{ .plant.ParentName }}</a></li>
                            {{ else }}
                            <li><strong>{{ .lcl.clone_of }}:</strong> {{ .lcl.title_unknown }}</li>
                            {{ end }}
                            {{ end }}

                            <li><strong>{{ .lcl.title_zone }}:</strong> {{ .plant.ZoneName }}</li>
                            <li><strong>{{ .lcl.start_date }}:</strong> {{ formatDateTime .plant.StartDT }}</li>

                            <!-- Conditional: If Plant is an Autoflower and not Harvested and not Dead OR if an estimated harvest date exists -->
                            {{ if and (ne .plant.Status "Success") (ne .plant.Status "Drying") (ne .plant.Status "Curing") (ne .plant.Status "Dead") }}
                                {{ if or (eq .plant.Autoflower true) (ne (formatDate .plant.EstHarvestDate) "01/01/1970") }}
                                    <li><strong>{{ .lcl.est_harvest_date }}:</strong> {{ formatDate .plant.EstHarvestDate }}</li>
                                {{ end }}
                            {{ end }}


                            <!-- Conditional: If Plant is Harvested or Dead -->
                            {{ if or (eq .plant.Status "Success") (eq .plant.Status "Drying") (eq .plant.Status "Curing") (eq .plant.Status "Dead") }}
                            <li><strong>{{ .lcl.harvest_date }}:</strong> {{ formatDateTime .plant.HarvestDate }}</li>
                            <li><strong>{{ .lcl.harvest_weight }}:</strong> {{ .plant.HarvestWeight }} {{ .lcl.title_grams }}</li>
                            {{ else }}
                            <li><strong>{{ .lcl.title_day }}:</strong> {{ .plant.CurrentDay }}</li>
                            <li><strong>{{ .lcl.title_week }}:</strong> {{ .plant.CurrentWeek }}</li>
                            {{ end }}

                            <!-- Optional: Last Watered or Fed -->
                            {{ if or (ne (formatDateTime .plant.LastWaterDate) "01/01/1970") (ne (formatDateTime .plant.LastFeedDate) "01/01/1970") }}
                            <li><strong>{{ .lcl.last_watered_or_fed }}:</strong>
                                {{ if gt (formatDateTime .plant.LastWaterDate) (formatDateTime .plant.LastFeedDate) }}
                                {{ formatDateTime .plant.LastWaterDate }} ({{ .lcl.title_watered }})
                                {{ else }}
                                {{ formatDateTime .plant.LastFeedDate }} ({{ .lcl.title_fed }})
                                {{ end }}
                            </li>
                            {{ end }}
                        </ul>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                {{ if .loggedIn }}
                <div class="card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-around">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">
                                <i class="fa-solid fa-plus"></i> {{ .lcl.add_measurement }}
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                                <i class="fa-solid fa-plus"></i> {{ .lcl.add_activity }}
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImagesModal">
                                <i class="fa-solid fa-plus"></i> {{ .lcl.upload_images }}
                            </button>
                        </div>
                    </div>
                </div>
                {{ end }}
            </div>

        </div>
    </div>

    <!-- Plant Status Ribbon -->
    <!-- Renders a horizontal timeline of statuses; JS will hydrate dates and click behavior -->
    <div id="plantStatusRibbonContainer" class="mb-4"
         data-plant-id="{{ .plant.ID }}"
         data-current-status-id="{{ .plant.StatusID }}"
         data-status-history='{{ jsonify .plant.StatusHistory }}'>
        <div class="card">
            <div class="card-body">
                <div class="plant-status-ribbon d-flex justify-content-between align-items-center" role="navigation" aria-label="{{ .lcl.growth_stage_timeline }}">
                    {{ range $idx, $s := .statuses }}
                    {{ $lbl := index $.lcl (print (lower $s.Status) "_label") }}
                    <div class="status-step text-center" data-status-id="{{ $s.ID }}" data-status-name="{{ $s.Status }}" data-status-index="{{ $idx }}">
                        <button class="btn status-icon" aria-label="{{ if $lbl }}{{ $lbl }}{{ else }}{{ $s.Status }}{{ end }}">
                            <i class="fa-solid fa-lemon fa-2x"></i>
                        </button>
                        <div class="status-name small text-muted">{{ if $lbl }}{{ $lbl }}{{ else }}{{ $s.Status }}{{ end }}</div>
                        <div class="status-date small mt-1">
                            <span class="status-date-day"></span>
                            <span class="status-date-time"></span>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/plant-status-ribbon.js"></script>


    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="plantDetailsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button" role="tab" aria-controls="sensors" aria-selected="false">
                {{ .lcl.title_sensors }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="growthHistory-tab" data-bs-toggle="tab" data-bs-target="#growthHistory" type="button" role="tab" aria-controls="growthHistory" aria-selected="false">
                {{ .lcl.growth_history }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="measurements-tab" data-bs-toggle="tab" data-bs-target="#measurements" type="button" role="tab" aria-controls="measurements" aria-selected="false">
                {{ .lcl.title_measurements }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="false">
                {{ .lcl.title_activities }}
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="plantDetailsTabsContent">
        <!-- Sensors Tab -->
        <div class="tab-pane fade show active" id="sensors" role="tabpanel" aria-labelledby="sensors-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">{{ .lcl.title_sensors }}</h3>
                {{ if .loggedIn }}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linkSensorModal">
                    <i class="fa-solid fa-link"></i> {{ .lcl.link_sensors }}
                </button>
                {{ end }}
            </div>
            <div class="row g-4">
                {{ range .plant.Sensors }}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <a href="/graph/{{.ID}}" class="text-decoration-none">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ .Name }}</h5>
                                <p class="display-6 fw-bold">{{ .Value }} {{ .Unit }}</p>
                                <small class="text-muted">{{ toLocalTimeString .Date }}</small>
                            </div>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Growth History Tab -->
        <div class="tab-pane fade" id="growthHistory" role="tabpanel" aria-labelledby="growthHistory-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">{{ .lcl.growth_history }}</h3>
            </div>
            <div class="growth-history-card" id="growthHistorySection"
                 data-current-stage="{{ .plant.Status }}"
                 data-days-label="{{ .lcl.title_days }}"
                 data-empty-label="{{ .lcl.growth_history_empty }}">
                <script type="application/json" id="growthHistoryData">{{ jsonify .plant.StatusHistory }}</script>
                <div class="row g-4 growth-history-grid" id="growthHistoryGrid">
                    <div class="col-12 col-lg-6">
                        <div class="card h-100 growth-history-panel">
                            <div class="card-body">
                                <div class="growth-section">
                                    <div class="growth-section-title">{{ .lcl.current_growth_stage }}</div>
                                    <div class="growth-current-value" id="growthCurrentStage">-</div>
                                    <div class="growth-current-meta"><span id="growthCurrentDays">0</span> {{ .lcl.days_in_stage }}</div>
                                </div>
                                <div class="growth-section">
                                    <div class="growth-section-title">{{ .lcl.days_in_each_growth_stage }}</div>
                                    <div class="growth-stage-list" id="growthStageList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="card h-100 growth-history-panel">
                            <div class="card-body">
                                <div class="growth-timeline-header">
                                    <div class="growth-section-title">{{ .lcl.growth_stage_timeline }}</div>
                                    <div class="growth-total-pill">
                                        <span>{{ .lcl.total_days }}</span>
                                        <strong id="growthTotalDays">0</strong>
                                    </div>
                                </div>
                                <div class="growth-timeline" id="growthTimeline" aria-label="{{ .lcl.growth_stage_timeline }}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="growth-history-empty d-none" id="growthHistoryEmpty">{{ .lcl.growth_history_empty }}</div>
            </div>
        </div>

        <!-- Measurements Tab -->
        <div class="tab-pane fade" id="measurements" role="tabpanel" aria-labelledby="measurements-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">{{ .lcl.title_measurements }}</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>{{ .lcl.title_date }}</th>
                    <th>{{ .lcl.title_measurement }}</th>
                    <th>{{ .lcl.title_value }}</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Measurements }}
                <tr class="clickable-row measurement-row" data-measurement='{{ json . }}'>
                    <td>{{ formatDateTime .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ .Value }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Activities Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">{{ .lcl.title_activities }}</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>{{ .lcl.title_date }}</th>
                    <th>{{ .lcl.title_activity }}</th>
                    <th>{{ .lcl.title_note }}</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Activities }}
                <tr class="clickable-row activity-row" data-activity='{{ json . }}'>
                    <td>{{ formatDateTime .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ preview .Note }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

    </div>

    <hr class="my-5" />

    <!-- Image Gallery Tab -->
    <div class="row g-4" id="gallery">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="text-secondary">{{ .lcl.image_gallery }}</h3>
        </div>
        <div class="row g-3">
            {{ range .plant.Images }}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card">
                    <img
                            src="{{ .ImagePath }}"
                            class="card-img-top thumbnail-img"
                            alt="{{ .ImageDescription }}"
                            data-bs-toggle="modal"
                            data-bs-target="#imageModal"
                            data-image="{{ .ImagePath }}"
                            data-description="{{ .ImageDescription }}"
                            data-date="{{ formatDate .ImageDate }}"
                            data-id="{{ .ID }}"
                    >
                    <div class="card-body text-center">
                        <small class="text-muted">{{ formatDate .ImageDate }}</small>
                    </div>
                </div>

            </div>
            {{ end }}
        </div>
    </div>
</div>

{{ template "modals/upload-images-modal.html" . }}
{{ template "modals/decorate-image-modal.html" . }}
{{ template "modals/link-sensor-modal.html" . }}
{{ template "modals/edit-plant-modal.html" . }}
{{ template "modals/add-measurement-modal.html" . }}
{{ template "modals/add-activity-modal.html" . }}
{{ template "modals/status-history-edit-modal.html" . }}
{{ template "modals/measurement-edit-modal.html" . }}
{{ template "modals/activity-edit-modal.html" . }}
<!--Embed the footer.html template at this location-->
{{ template "common/footer.html" .}}

{{ end }}