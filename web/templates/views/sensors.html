{{ define "views/sensors.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "common/header.html" .}}
{{ template "common/header2.html" .}}

<div class="container">
    <!-- Action Buttons -->
    <div class="mb-4">
        {{ if .settings.ACI.Enabled }}
        <button class="btn btn-primary me-2" id="scanACI">
            <i class="fa-solid fa-search"></i> {{ .lcl.aci_scan_add }}
        </button>
        <!-- Dump ACI JSON button -->
        <button class="btn btn-outline-secondary me-2" id="dumpACI">
            <i class="fa-solid fa-file-code"></i> {{ .lcl.aci_dump_json }}
        </button>
        {{ end }}

        {{ if .settings.EC.Enabled }}
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#ecScanModal" id="scanEC">
            <i class="fa-solid fa-search"></i> {{ .lcl.ecowitt_scan_add }}
        </button>
        {{ end }}
    </div>

    <!-- EcoWitt Scan Modal -->
    <div class="modal fade" id="ecScanModal" tabindex="-1" aria-labelledby="ecScanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ecScanModalLabel">{{ .lcl.ecowitt_scan }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ecScanForm">
                        <!-- Server Address -->
                        <div class="mb-3">
                            <label for="serverAddress" class="form-label">{{ .lcl.server_address }}</label>
                            <input type="text" class="form-control" id="serverAddress" placeholder="{{ .lcl.server_address_placeholder }}" required>
                        </div>
                        <!-- Zone Selection -->
                        <div class="mb-3">
                            <label for="ecZoneSelect" class="form-label">{{ .lcl.title_zone }}</label>
                            <select class="form-select" id="ecZoneSelect" required>
                                {{ range .zones }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                                <option value="new">{{ .lcl.add_new_zone }}</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="ecNewZoneInput">
                            <label for="ecNewZoneName" class="form-label">{{ .lcl.new_zone_name }}</label>
                            <input type="text" class="form-control" id="ecNewZoneName" placeholder="{{ .lcl.enter_zone_name }}">
                        </div>
                        <button type="submit" class="btn btn-primary">{{ .lcl.scan_sensors }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Sensors Table -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="table-dark">
            <tr>
                <th>{{ .lcl.title_id }}</th>
                <th>{{ .lcl.title_name }}</th>
                <th>{{ .lcl.title_zone }}</th>
                <th>{{ .lcl.title_source }}</th>
                <th>{{ .lcl.title_device }}</th>
                <th>{{ .lcl.title_type }}</th>
                <th>{{ .lcl.title_unit }}</th>
                <th>{{ .lcl.title_show_hide }}</th>
                <th>{{ .lcl.title_created }}</th>
                <th>{{ .lcl.title_updated }}</th>
            </tr>
            </thead>
            <tbody>
            {{ range .sensors }}
            <tr class="clickable-row" data-sensor='{{ json . }}'>
                <td>{{ .id }}</td>
                <td>{{ .name }}</td>
                <td>{{ .zone }}</td>
                <td>{{ .source }}</td>
                <td>{{ .device }}</td>
                <td>{{ .type }}</td>
                <td>{{ .unit }}</td>
                <td>{{ if .visible }}{{ .lcl.title_show }}{{ else }}{{ .lcl.title_hide }}{{ end }}</td>
                <td>{{ formatStringDate .create_dt }}</td>
                <td>{{ formatStringDate .update_dt }}</td>
            </tr>
            {{ end }}
            </tbody>
        </table>
    </div>
</div>


<!-- Zone Selection Modal -->
<div class="modal fade" id="zoneModal" tabindex="-1" aria-labelledby="zoneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="zoneModalLabel">{{ .lcl.select_zone }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ .lcl.title_close }}"></button>
            </div>
            <div class="modal-body">
                <form id="zoneForm">
                    <div class="mb-3">
                        <label for="zoneSelect" class="form-label">{{ .lcl.title_zone }}</label>
                        <select class="form-select" id="zoneSelect" required>
                            {{ range .zones }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">{{ .lcl.add_new_zone }}</option>
                        </select>
                        <div class="form-text" id="noZoneHelp" style="display: none;">
                            {{ .lcl.no_zones_available }}
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="newZoneInput">
                        <label for="newZoneName" class="form-label">{{ .lcl.new_zone_name }}</label>
                        <input type="text" class="form-control" id="newZoneName" placeholder="{{ .lcl.enter_zone_name }}">
                    </div>
                    <button type="submit" class="btn btn-primary">{{ .lcl.title_proceed }}</button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- Modal for Edit Sensor -->
<div class="modal fade" id="editSensorModal" tabindex="-1" aria-labelledby="editSensorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSensorModalLabel">{{ .lcl.edit_sensor }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ .lcl.title_close }}"></button>
            </div>
            <div class="modal-body">
                <form id="editSensorForm">
                    <!-- Sensor ID (Hidden) -->
                    <input type="hidden" id="sensorId">

                    <!-- Sensor Name -->
                    <div class="mb-3">
                        <label for="sensorName" class="form-label">{{ .lcl.sensor_name }}</label>
                        <input type="text" class="form-control" id="sensorName" required>
                    </div>

                    <!-- Sensor Device -->
                    <div class="mb-3">
                        <label for="sensorDevice" class="form-label">{{ .lcl.title_device }}</label>
                        <input type="text" class="form-control" id="sensorDevice" required>
                        <p class="form-text">{{ .lcl.edit_device_info }}</p>
                    </div>

                    <!-- Show/Hide -->
                    <div class="mb-3">
                        <label for="sensorVisibility" class="form-label">{{ .lcl.title_visibility }}</label>
                        <select class="form-select" id="sensorVisibility" required>
                            <option value="true">{{ .lcl.title_show }}</option>
                            <option value="false">{{ .lcl.title_hide }}</option>
                        </select>
                    </div>

                    <!-- Zone Dropdown -->
                    <div class="mb-3">
                        <label for="sensorZone" class="form-label">{{ .lcl.title_zone }}</label>
                        <select class="form-select" id="sensorZone" required>
                            {{ range .zones }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>

                    <!-- Unit -->
                    <div class="mb-3">
                        <label for="sensorUnit" class="form-label">{{ .lcl.title_unit }}</label>
                        <input type="text" class="form-control" id="sensorUnit" required>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> {{ .lcl.save_changes }}</button>
                        <button type="button" class="btn btn-danger" id="deleteSensor">
                            <span id="deleteSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="fa-solid fa-trash"></i> {{ .lcl.delete_sensor }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal to display raw AC Infinity JSON -->
<div class="modal fade" id="dumpACIModal" tabindex="-1" aria-labelledby="dumpACIModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dumpACIModalLabel">{{ .lcl.aci_dump_json }}</h5>
                <!-- Added Refresh and Copy buttons for convenience -->
                <div class="btn-group ms-2" role="group" aria-label="ACI dump actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="dumpACIRefresh" title="Refresh JSON"><i class="fa-solid fa-arrows-rotate"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="dumpACICopy" title="Copy JSON"><i class="fa-regular fa-copy"></i></button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dumpACIStatus" class="mb-2"></div>
                <p class="small text-muted">{{ .lcl.aci_dump_json_desc }}</p>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="1" id="dumpACIRedact" checked>
                    <label class="form-check-label" for="dumpACIRedact">
                        {{ .lcl.aci_redact_label }}
                    </label>
                </div>
                <p class="small text-muted text-warning">{{ .lcl.aci_dump_json_caution }}</p>
                 <pre id="dumpACIContent" style="max-height:60vh; overflow:auto; padding:1rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Segoe UI Mono', monospace; background: inherit; color: inherit; border: 1px solid rgba(0,0,0,0.08); border-radius: .25rem;"></pre>
             </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        let currentScanEndpoint = "";

        // Show the modal for ACI scan
        document.getElementById("scanACI")?.addEventListener("click", () => {
            currentScanEndpoint = "/sensors/scanACI";
            showZoneModal();
        });

        // Show the modal for EcoWitt scan
        document.getElementById("scanEC")?.addEventListener("click", () => {
            currentScanEndpoint = "/sensors/scanEC";
            showEcoWittZoneModal();
        });

        // ACI Modal: Handle Zone Dropdown Change
        document.getElementById("zoneSelect")?.addEventListener("change", (e) => {
            const newZoneInput = document.getElementById("newZoneInput");
            if (e.target.value === "new") {
                newZoneInput.classList.remove("d-none");
            } else {
                newZoneInput.classList.add("d-none");
            }
        });

        // EcoWitt Modal: Handle Zone Dropdown Change
        document.getElementById("ecZoneSelect")?.addEventListener("change", (e) => {
            const ecNewZoneInput = document.getElementById("ecNewZoneInput");
            if (e.target.value === "new") {
                ecNewZoneInput.classList.remove("d-none");
            } else {
                ecNewZoneInput.classList.add("d-none");
            }
        });

        // Show Zone Modal for ACI Scan
        const showZoneModal = () => {
            const zoneSelect = document.getElementById("zoneSelect");
            const newZoneInput = document.getElementById("newZoneInput");
            const noZoneHelp = document.getElementById("noZoneHelp");

            // Reset the modal state
            zoneSelect.value = "";
            newZoneInput.classList.add("d-none");
            noZoneHelp.style.display = "none";

            // If no zones exist, automatically select "Add New Zone"
            if (zoneSelect.options.length <= 1) {
                zoneSelect.value = "new";
                newZoneInput.classList.remove("d-none");
                noZoneHelp.style.display = "block";
            }

            const modal = new bootstrap.Modal(document.getElementById("zoneModal"));
            modal.show();
        };

        // Show EcoWitt Zone Modal
        const showEcoWittZoneModal = () => {
            const ecZoneSelect = document.getElementById("ecZoneSelect");
            const ecNewZoneInput = document.getElementById("ecNewZoneInput");
            const ecNewZoneName = document.getElementById("ecNewZoneName");

            ecZoneSelect.value = "";
            ecNewZoneInput.classList.add("d-none");
            ecNewZoneName.value = "";

            if (ecZoneSelect.options.length <= 1) {
                ecZoneSelect.value = "new";
                ecNewZoneInput.classList.remove("d-none");
            }

            const modal = new bootstrap.Modal(document.getElementById("ecScanModal"));
            modal.show();
        };


        // Ensure modal cleanup on hide
        const modals = [document.getElementById("zoneModal"), document.getElementById("ecScanModal")];
        modals.forEach(modalElement => {
            modalElement.addEventListener("hidden.bs.modal", () => {
                // Remove lingering modal-backdrop elements
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());

                // Ensure the body class does not remain disabled
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            });
        });

        // Handle Zone Form Submission (shared logic for both AC Infinity and EcoWitt)
        document.getElementById("zoneForm").addEventListener("submit", (e) => {
            e.preventDefault();

            const zoneSelect = document.getElementById("zoneSelect");
            const newZoneName = document.getElementById("newZoneName").value;

            const payload = {
                zone_id: zoneSelect.value === "new" ? null : parseInt(zoneSelect.value, 10),
                new_zone: zoneSelect.value === "new" ? newZoneName : null,
            };

            if (!currentScanEndpoint) {
                uiMessages.showToast('No scan endpoint defined.', 'warning');
                return;
            }

            // Send POST request to the selected scan endpoint
            fetch(currentScanEndpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("{{ .lcl.failed_sensor_scan }}");
                    }
                    return response.json();
                })
                .then(() => {
                    window.location.reload();
                })
                .catch((error) => {
                    console.error("Error:", error);
                    uiMessages.showToast(uiMessages.t('failed_sensor_scan') || '{{ .lcl.failed_sensor_scan }}', 'danger');
                });
        });

        // Handle EcoWitt-specific Zone Form Submission
        document.getElementById("ecScanForm")?.addEventListener("submit", (e) => {
            e.preventDefault();

            const ecZoneSelect = document.getElementById("ecZoneSelect");
            const ecNewZoneName = document.getElementById("ecNewZoneName").value;

            const serverAddress = document.getElementById("serverAddress").value;

            const payload = {
                zone_id: ecZoneSelect.value === "new" ? null : parseInt(ecZoneSelect.value, 10),
                new_zone: ecZoneSelect.value === "new" ? ecNewZoneName : null,
                server_address: serverAddress,
            };

            if (!currentScanEndpoint) {
                uiMessages.showToast(uiMessages.t('no_scan_endppoint') || '{{ .lcl.no_scan_endppoint }}', 'warning');
                return;
            }

            // Send POST request to the EcoWitt scan endpoint
            fetch(currentScanEndpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("{{ .lcl.failed_sensor_scan }}");
                    }
                    return response.json();
                })
                .then(() => {
                    window.location.reload();
                })
                .catch((error) => {
                    console.error("Error:", error);
                    uiMessages.showToast(uiMessages.t('failed_sensor_scan') || '{{ .lcl.failed_sensor_scan }}', 'danger');
                });
        });

        // Utility: fetch the ACI dump and update UI. If `showModal` is true, show the modal after fetching.
        const fetchDumpACI = async (showModal = false) => {
            const statusEl = document.getElementById('dumpACIStatus');
            const contentEl = document.getElementById('dumpACIContent');
            const redactCheckbox = document.getElementById('dumpACIRedact');
            const redact = redactCheckbox && redactCheckbox.checked ? 'true' : 'false';

            statusEl.innerHTML = 'Fetching...';
            contentEl.textContent = '';

            try {
                const resp = await fetch('/sensors/dumpACI?redact=' + redact, { method: 'GET' });
                if (!resp.ok) {
                    throw new Error('Failed to fetch AC Infinity JSON');
                }
                const text = await resp.text();
                contentEl.textContent = text;
                statusEl.innerHTML = '';
                if (showModal) {
                    const modal = new bootstrap.Modal(document.getElementById('dumpACIModal'));
                    modal.show();
                }
            } catch (err) {
                statusEl.innerHTML = '<div class="text-danger">Error fetching AC Infinity JSON</div>';
                console.error(err);
            }
        };

        // Dump ACI JSON button handler (initial fetch then show modal)
        document.getElementById("dumpACI")?.addEventListener("click", async () => {
            await fetchDumpACI(true);
        });

        // Refresh button inside the modal
        document.getElementById("dumpACIRefresh")?.addEventListener("click", async () => {
            await fetchDumpACI(false);
        });

        // When redact checkbox toggled, refresh the JSON if the modal is currently open
        document.getElementById('dumpACIRedact')?.addEventListener('change', async (e) => {
            const modalEl = document.getElementById('dumpACIModal');
            if (modalEl.classList.contains('show')) {
                await fetchDumpACI(false);
            }
        });

        // Copy button: copy pre content to clipboard and show temporary status
        document.getElementById('dumpACICopy')?.addEventListener('click', async () => {
            const contentEl = document.getElementById('dumpACIContent');
            const statusEl = document.getElementById('dumpACIStatus');
            const text = contentEl.textContent || '';
            if (!text) {
                statusEl.innerHTML = '<div class="text-muted">Nothing to copy</div>';
                setTimeout(() => statusEl.innerHTML = '', 1500);
                return;
            }

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    textarea.remove();
                }
                statusEl.innerHTML = '<div class="text-success">Copied to clipboard</div>';
                setTimeout(() => statusEl.innerHTML = '', 1500);
            } catch (err) {
                console.error('Copy failed', err);
                statusEl.innerHTML = '<div class="text-danger">Failed to copy</div>';
                setTimeout(() => statusEl.innerHTML = '', 2000);
            }
        });

    });


</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const editSensorModal = new bootstrap.Modal(document.getElementById("editSensorModal"));
        const sensorForm = document.getElementById("editSensorForm");
        const deleteButton = document.getElementById("deleteSensor");

        let currentSensor = null;

        // Row click opens the modal with sensor data
        document.querySelectorAll(".clickable-row").forEach(row => {
            row.addEventListener("click", () => {
                const sensorData = JSON.parse(row.getAttribute("data-sensor"));
                currentSensor = sensorData;

                // Populate modal fields
                document.getElementById("sensorId").value = sensorData.id;
                document.getElementById("sensorName").value = sensorData.name;
                document.getElementById("sensorDevice").value = sensorData.device;

                // Populate visibility (ensure it's boolean in the backend)
                document.getElementById("sensorVisibility").value = sensorData.visible ? "true" : "false";

                // Populate unit
                document.getElementById("sensorUnit").value = sensorData.unit;

                // Populate zone dropdown
                document.getElementById("sensorZone").value = sensorData.zone_id;

                editSensorModal.show();
            });
        });

        // Save changes
        sensorForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("sensorId").value, 10),
                name: document.getElementById("sensorName").value,
                device: document.getElementById("sensorDevice").value,
                visible: document.getElementById("sensorVisibility").value === "true",
                zone_id: parseInt(document.getElementById("sensorZone").value, 10),
                unit: document.getElementById("sensorUnit").value,
            };

            fetch("/sensors/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) throw new Error("{{ .lcl.failed_save_changes }}");
                    return response.json();
                })
                .then(data => {
                    //uiMessages.showToast(uiMessages.t('sensor_updated_successfully') || 'Sensor updated successfully!', 'success');
                    window.location.reload();
                })
                .catch(error => {
                    console.error("Error:", error);
                    uiMessages.showToast(uiMessages.t('failed_update_sensor') || '{{ .lcl.failed_update_sensor }}', 'danger');
                });
        });

        // Delete sensor
        deleteButton.addEventListener("click", () => {
            uiMessages.showConfirm(uiMessages.t('confirm_delete_sensor') || '{{ .lcl.confirm_delete_sensor }}').then(confirmed => {
                if (!confirmed) return;
                // Show spinner and disable buttons so user knows deletion is in progress
                const spinner = document.getElementById('deleteSpinner');
                const saveBtn = sensorForm.querySelector('button[type="submit"]');
                deleteButton.disabled = true;
                if (saveBtn) saveBtn.disabled = true;
                if (spinner) spinner.classList.remove('d-none');

                fetch(`/sensors/delete/${currentSensor.id}`, { method: "DELETE" })
                    .then(response => {
                        if (!response.ok) throw new Error("{{ .lcl.failed_delete_sensor }}");
                        //uiMessages.showToast(uiMessages.t('sensor_deleted_successfully') || 'Sensor deleted successfully!', 'success');
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        // Re-enable controls and hide spinner on error
                        if (spinner) spinner.classList.add('d-none');
                        deleteButton.disabled = false;
                        if (saveBtn) saveBtn.disabled = false;
                        uiMessages.showToast(uiMessages.t('failed_delete_sensor') || '{{ .lcl.failed_delete_sensor }}', 'danger');
                    });
            });
        });
    });
</script>


<!--Embed the footer.html template at this location-->
{{ template "common/footer.html" .}}

{{ end }}