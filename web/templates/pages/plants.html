{{ define "views/plants.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "layouts/header.html" .}}
<meta http-equiv="refresh" content="300">
<style>
    .clickable-row {
        cursor: pointer;
    }
    /* Default button styles */
    .view-button {
        background-color: transparent;
        color: #6c757d; /* Bootstrap secondary color */
        border: 1px solid #ced4da;
        transition: background-color 0.3s, color 0.3s;
    }

    /* Hover effect */
    .view-button:hover {
        background-color: #e9ecef; /* Light gray */
        color: #495057; /* Dark gray */
    }

    /* Selected button styles */
    .view-button.active {
        background-color: #0d6efd; /* Bootstrap primary color */
        color: #ffffff; /* White text */
        border-color: #0d6efd;
    }
    .sortable {
        cursor: pointer;
    }

    .sortable.asc::after {
        content: " ▲";
    }

    .sortable.desc::after {
        content: " ▼";
    }

</style>
{{ template "layouts/header2.html" .}}


<header class="masthead text-center">
    <div class="overlay"></div>


    <div class="container">
        <div class="mb-4">
            <!-- View Selector -->
            <div class="mb-4 d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <button class="btn view-button active" data-view="living">Living Plants</button>
                    <button class="btn view-button" data-view="harvested">Harvested Plants</button>
                    <button class="btn view-button" data-view="dead">Dead Plants</button>
                </div>
                <div class="d-flex align-items-center">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-search"></i></span>
                        <input type="text" class="form-control" id="searchPlants" placeholder="Search plants...">
                    </div>
                    <button class="btn btn-success ms-3" data-bs-toggle="modal" data-bs-target="#addPlantModal">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

        </div>


        <!-- Table -->
        <div class="row">
            <div class="col-12">
                <table class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th scope="col" data-sort="name" data-type="text" class="sortable">Plant <i class="fa-solid fa-sort"></i></th>
                        <th scope="col" data-sort="strain" data-type="text" class="sortable">Strain <i class="fa-solid fa-sort"></i></th>
                        <th scope="col" data-sort="breeder" data-type="text" class="sortable">Breeder <i class="fa-solid fa-sort"></i></th>
                        <th scope="col" data-sort="start_date" data-type="date" class="sortable">Start Date <i class="fa-solid fa-sort"></i></th>
                        <th scope="col" data-sort="week" data-type="numeric" class="sortable">Current Week <i class="fa-solid fa-sort"></i></th>
                        <th scope="col" data-sort="day" data-type="numeric" class="sortable">Current Day <i class="fa-solid fa-sort"></i></th>
                    </tr>
                    </thead>
                    <tbody id="plantsTableBody">
                    <!-- Rows populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</header>

<!-- Add Plant Modal -->
<div class="modal fade" id="addPlantModal" tabindex="-1" aria-labelledby="addPlantModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPlantModalLabel">Add New Plant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPlantForm">
                    <!-- Plant Name -->
                    <div class="mb-3">
                        <label for="plantName" class="form-label">Plant Name</label>
                        <input type="text" class="form-control" id="plantName" placeholder="Enter Plant Name" required>
                    </div>

                    <!-- Zone Dropdown -->
                    <div class="mb-3">
                        <label for="zoneSelect" class="form-label">Zone</label>
                        <select class="form-select" id="zoneSelect" required>
                            {{ range .zones }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">Add New Zone</option>
                        </select>
                    </div>

                    <!-- New Zone Input -->
                    <div class="mb-3 d-none" id="newZoneInput">
                        <label for="newZoneName" class="form-label">New Zone Name</label>
                        <input type="text" class="form-control" id="newZoneName" placeholder="Enter Zone Name">
                    </div>

                    <!-- Strain Dropdown -->
                    <div class="mb-3">
                        <label for="strainSelect" class="form-label">Strain</label>
                        <select class="form-select" id="strainSelect" required>
                            {{ range .strains }}
                            <option value="{{ .ID }}">{{ .Name }} ({{ .Breeder }})</option>
                            {{ end }}
                            <option value="new">Add New Strain</option>
                        </select>
                    </div>

                    <!-- New Strain Inputs -->
                    <div class="mb-3 d-none" id="newStrainInputs">
                        <label for="newStrainName" class="form-label">Strain Name</label>
                        <input type="text" class="form-control" id="newStrainName" placeholder="Enter Strain Name">

                        <!-- Breeder Dropdown -->
                        <div class="mb-3">
                            <label for="breederSelect" class="form-label">Breeder</label>
                            <select class="form-select" id="breederSelect">
                                {{ range .breeders }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                                <option value="new">Add New Breeder</option>
                            </select>
                        </div>

                        <!-- New Breeder Input -->
                        <div class="mb-3 d-none" id="newBreederInput">
                            <label for="newBreederName" class="form-label">New Breeder Name</label>
                            <input type="text" class="form-control" id="newBreederName" placeholder="Enter Breeder Name">
                        </div>
                    </div>

                    <!-- Status Dropdown -->
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select class="form-select" id="statusSelect" required>
                            {{ range .statuses }}
                            <option value="{{ .ID }}">{{ .Status }}</option>
                            {{ end }}
                        </select>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Plant</button>
                </form>
            </div>
        </div>
    </div>
</div>



<script>
    document.addEventListener("DOMContentLoaded", () => {
        const viewButtons = document.querySelectorAll(".view-button");

        viewButtons.forEach(button => {
            button.addEventListener("click", () => {
                // Remove 'active' class from all buttons
                viewButtons.forEach(btn => btn.classList.remove("active"));

                // Add 'active' class to the clicked button
                button.classList.add("active");

                // Trigger view change logic here
                const selectedView = button.dataset.view;
                console.log(`View selected: ${selectedView}`);
                // Fetch and display the corresponding plants based on selectedView
            });
        });
    });


    document.addEventListener("DOMContentLoaded", () => {
        const plantsTableBody = document.getElementById("plantsTableBody");
        const searchPlants = document.getElementById("searchPlants");
        const viewButtons = document.querySelectorAll(".view-button");
        let currentView = "living"; // Default view
        let plantsData = []; // Store all plant data
        let sortColumn = null;
        let sortDirection = "asc"; // Default sort direction

        // Fetch plants and update the table
        const fetchPlants = (view) => {
            fetch(`/plants/${view}`)
                .then(response => response.json())
                .then(data => {
                    plantsData = data;
                    updateTable();
                })
                .catch(err => console.error("Error fetching plants:", err));
        };

        // Update the table with filtered and sorted data
        const updateTable = () => {
            const searchTerm = searchPlants.value.toLowerCase();
            let filteredPlants = plantsData.filter(plant =>
                plant.name.toLowerCase().includes(searchTerm) ||
                plant.strain_name.toLowerCase().includes(searchTerm) ||
                plant.breeder_name.toLowerCase().includes(searchTerm)
            );

            // Sort filtered data
            if (sortColumn) {
                filteredPlants.sort((a, b) => {
                    const valA = a[sortColumn];
                    const valB = b[sortColumn];

                    if (valA < valB) return sortDirection === "asc" ? -1 : 1;
                    if (valA > valB) return sortDirection === "asc" ? 1 : -1;
                    return 0;
                });
            }

            // Populate table
            plantsTableBody.innerHTML = filteredPlants.map(plant => `
                <tr class="clickable-row" data-id="${plant.id}">
                    <th scope="row">${plant.name}</th>
                    <td>${plant.strain_name}</td>
                    <td>${plant.breeder_name}</td>
                    <td>${plant.start_dt ? new Date(plant.start_dt).toLocaleDateString() : "-"}</td>
                    <td>${plant.current_week || "-"}</td>
                    <td>${plant.current_day || "-"}</td>
                </tr>
            `).join("");

            // Add click events for table rows
            document.querySelectorAll(".clickable-row").forEach(row => {
                row.addEventListener("click", () => {
                    const plantId = row.getAttribute("data-id");
                    if (plantId) {
                        window.location.href = `/plant/${plantId}`;
                    }
                });
            });
        };

        // Handle view change
        viewButtons.forEach(button => {
            button.addEventListener("click", () => {
                currentView = button.dataset.view;
                fetchPlants(currentView);

                // Update button styles
                viewButtons.forEach(btn => btn.classList.remove("btn-primary"));
                button.classList.add("btn-primary");
            });
        });

        // Handle column sorting
        document.querySelectorAll(".sortable").forEach(header => {
            header.addEventListener("click", () => {
                const column = header.getAttribute("data-sort");
                if (sortColumn === column) {
                    // Toggle sort direction if already sorted by this column
                    sortDirection = sortDirection === "asc" ? "desc" : "asc";
                } else {
                    // Set new column and reset direction
                    sortColumn = column;
                    sortDirection = "asc";
                }
                updateTable();
            });
        });

        // Handle search
        searchPlants.addEventListener("input", () => {
            updateTable();
        });

        // Fetch initial data
        fetchPlants(currentView);
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const addPlantForm = document.getElementById("addPlantForm");
        const zoneSelect = document.getElementById("zoneSelect");
        const newZoneInput = document.getElementById("newZoneInput");
        const strainSelect = document.getElementById("strainSelect");
        const newStrainInputs = document.getElementById("newStrainInputs");
        const breederSelect = document.getElementById("breederSelect");
        const newBreederInput = document.getElementById("newBreederInput");
        const plantName = document.getElementById("plantName");
        const statusSelect = document.getElementById("statusSelect");
        const newZoneName = document.getElementById("newZoneName");
        const newStrainName = document.getElementById("newStrainName");
        const newBreederName = document.getElementById("newBreederName");
        const startDt = document.getElementById("startDate");
        const addPlantModal = document.getElementById("addPlantModal");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            startDt.value = today;
        };

        // Reset Zone Selection
        const resetZoneSelection = () => {
            zoneSelect.disabled = false;
            zoneSelect.value = "";
            newZoneInput.classList.add("d-none");
        };

        // Reset Strain Selection
        const resetStrainSelection = () => {
            strainSelect.value = "";
            newStrainInputs.classList.add("d-none");
            resetBreederSelection();
        };

        // Reset Breeder Selection
        const resetBreederSelection = () => {
            breederSelect.value = "";
            newBreederInput.classList.add("d-none");
        };

        // Set default behaviors when the modal is shown
        addPlantModal.addEventListener("show.bs.modal", () => {
            setDefaultDate();
            resetZoneSelection();
            resetStrainSelection();
        });

        // Show/Hide New Zone Input
        zoneSelect.addEventListener("change", () => {
            if (zoneSelect.value === "new") {
                newZoneInput.classList.remove("d-none");
            } else {
                newZoneInput.classList.add("d-none");
            }
        });

        // Show/Hide New Strain Inputs
        strainSelect.addEventListener("change", () => {
            if (strainSelect.value === "new") {
                newStrainInputs.classList.remove("d-none");
            } else {
                newStrainInputs.classList.add("d-none");
            }
        });

        // Show/Hide New Breeder Input
        breederSelect.addEventListener("change", () => {
            if (breederSelect.value === "new") {
                newBreederInput.classList.remove("d-none");
            } else {
                newBreederInput.classList.add("d-none");
            }
        });

        // Handle Add Plant Form Submission
        addPlantForm.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const payload = {
                name: plantName.value,
                zone_id: zoneSelect.value === "new" ? null : parseInt(zoneSelect.value, 10),
                new_zone: zoneSelect.value === "new" ? newZoneName.value : null,
                strain_id: strainSelect.value === "new" ? null : parseInt(strainSelect.value, 10),
                new_strain: strainSelect.value === "new" ? {
                    name: newStrainName.value,
                    breeder_id: breederSelect.value === "new" ? null : parseInt(breederSelect.value, 10),
                    new_breeder: breederSelect.value === "new" ? newBreederName.value : null
                } : null,
                status_id: parseInt(statusSelect.value, 10),
                date: startDt.value,
            };

            // Send POST request to add the plant
            fetch("/plants", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add plant");
                    }
                    return response.json();
                })
                .then(() => {
                    location.reload(); // Reload the page to show the new plant
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add plant. Please try again.");
                });
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const table = document.querySelector("table");
        const headers = table.querySelectorAll(".sortable");

        headers.forEach((header, columnIndex) => {
            header.addEventListener("click", () => {
                const type = header.dataset.type;
                const tbody = table.querySelector("tbody");
                const rows = Array.from(tbody.rows);
                const isAscending = header.classList.contains("asc");

                // Clear previous sort classes
                headers.forEach(h => h.classList.remove("asc", "desc"));

                // Sort rows based on column and type
                rows.sort((a, b) => {
                    const cellA = a.cells[columnIndex].textContent.trim();
                    const cellB = b.cells[columnIndex].textContent.trim();

                    if (type === "numeric") {
                        return isAscending ? cellA - cellB : cellB - cellA;
                    } else if (type === "date") {
                        return isAscending
                            ? new Date(cellA) - new Date(cellB)
                            : new Date(cellB) - new Date(cellA);
                    } else {
                        return isAscending
                            ? cellA.localeCompare(cellB)
                            : cellB.localeCompare(cellA);
                    }
                });

                // Append sorted rows back to the table body
                rows.forEach(row => tbody.appendChild(row));

                // Toggle sort direction
                header.classList.toggle("asc", !isAscending);
                header.classList.toggle("desc", isAscending);
            });
        });
    });

</script>


<!--Embed the footer.html template at this location-->
{{ template "layouts/footer.html" .}}

{{ end }}