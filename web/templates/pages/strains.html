{{ define "views/strains.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "layouts/header.html" .}}
<meta http-equiv="refresh" content="300">
<style>
    .clickable-row {
        cursor: pointer;
    }
</style>
{{ template "layouts/header2.html" .}}


<header class="masthead text-center">
    <div class="overlay"></div>
    <div class="container">
        <!-- Table Row -->
        <div class="container">
            <!-- Table Row -->
            <div class="mb-3 text-end">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStrainModal">
                    <i class="fa-solid fa-plus"></i> Add Strain
                </button>
            </div>

            <div class="row">
                <div class="col-12">
                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th scope="col">Strain</th>
                            <th scope="col">Breeder</th>
                            <th scope="col">I/S</th>
                            <th scope="col">Auto</th>
                            <th scope="col">Seed Count</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Iterate over strainList and display each strain's information in a table row -->
                        {{ range .strains }}
                        <tr class="clickable-row" data-id="{{ .ID }}" data-strain='{{ json . }}'>
                            <th scope="row">{{ .Name }}</th>
                            <td>{{ .Breeder }}</td>
                            <td>{{ .Indica }} / {{ .Sativa }}</td>
                            <td>{{ .Autoflower }}</td>
                            <td>{{ .SeedCount }}</td>
                        </tr>
                        {{ end }}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</header>
<!-- Add Strain Modal -->
<div class="modal fade" id="addStrainModal" tabindex="-1" aria-labelledby="addStrainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStrainModalLabel">Add New Strain</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStrainForm">
                    <!-- Strain Name -->
                    <div class="mb-3">
                        <label for="strainName" class="form-label">Strain Name</label>
                        <input type="text" class="form-control" id="strainName" placeholder="Enter strain name" required>
                    </div>

                    <!-- Breeder Dropdown -->
                    <div class="mb-3">
                        <label for="breederSelect" class="form-label">Breeder</label>
                        <select class="form-select" id="breederSelect" required>
                            {{ range .breeders }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">Add New Breeder</option>
                        </select>
                    </div>

                    <!-- New Breeder Input -->
                    <div class="mb-3 d-none" id="newBreederInput">
                        <label for="newBreederName" class="form-label">New Breeder Name</label>
                        <input type="text" class="form-control" id="newBreederName" placeholder="Enter new breeder name">
                    </div>

                    <!-- Indica / Sativa Ratio -->
                    <div class="mb-3">
                        <label for="indicaSativaSlider" class="form-label">Indica / Sativa Ratio</label>
                        <input type="range" class="form-range" id="indicaSativaSlider" min="0" max="100" value="50">
                        <div class="d-flex justify-content-between">
                            <small class="text-primary" id="indicaLabel">Indica: 50%</small>
                            <small class="text-success" id="sativaLabel">Sativa: 50%</small>
                        </div>
                    </div>

                    <!-- Autoflower -->
                    <div class="mb-3">
                        <label for="autoflower" class="form-label">Autoflower</label>
                        <select class="form-select" id="autoflower" required>
                            <option value="true">Yes</option>
                            <option value="false" selected>No</option>
                        </select>
                    </div>

                    <!-- Seed Count -->
                    <div class="mb-3">
                        <label for="seedCount" class="form-label">Seed Count</label>
                        <input type="number" class="form-control" id="seedCount" min="0" placeholder="Enter seed count" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="strainDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="strainDescription" rows="3" placeholder="Enter strain description"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Strain</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Edit Strain Modal -->
<div class="modal fade" id="editStrainModal" tabindex="-1" aria-labelledby="editStrainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStrainModalLabel">Edit Strain</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStrainForm">
                    <!-- Hidden Field for Strain ID -->
                    <input type="hidden" id="editStrainId">

                    <!-- Strain Name -->
                    <div class="mb-3">
                        <label for="editStrainName" class="form-label">Strain Name</label>
                        <input type="text" class="form-control" id="editStrainName" required>
                    </div>

                    <!-- Breeder Dropdown -->
                    <div class="mb-3">
                        <label for="editBreederSelect" class="form-label">Breeder</label>
                        <select class="form-select" id="editBreederSelect" required>
                            {{ range .breeders }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">Add New Breeder</option>
                        </select>
                    </div>

                    <!-- New Breeder Input -->
                    <div class="mb-3 d-none" id="editNewBreederInput">
                        <label for="editNewBreederName" class="form-label">New Breeder Name</label>
                        <input type="text" class="form-control" id="editNewBreederName" placeholder="Enter new breeder name">
                    </div>

                    <!-- Indica/Sativa Slider -->
                    <div class="mb-3">
                        <label for="editIndicaSativaSlider" class="form-label">Indica / Sativa Ratio</label>
                        <input type="range" class="form-range" id="editIndicaSativaSlider" min="0" max="100" value="50">
                        <div class="d-flex justify-content-between">
                            <small class="text-primary" id="editIndicaLabel">Indica: 50%</small>
                            <small class="text-success" id="editSativaLabel">Sativa: 50%</small>
                        </div>
                    </div>

                    <!-- Autoflower -->
                    <div class="mb-3">
                        <label for="editAutoflower" class="form-label">Autoflower</label>
                        <select class="form-select" id="editAutoflower" required>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>

                    <!-- Seed Count -->
                    <div class="mb-3">
                        <label for="editSeedCount" class="form-label">Seed Count</label>
                        <input type="number" class="form-control" id="editSeedCount" min="0">
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="editStrainDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editStrainDescription" rows="3"></textarea>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" id="deleteStrainButton">Delete Strain</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const addStrainForm = document.getElementById("addStrainForm");
        const breederSelect = document.getElementById("breederSelect");
        const newBreederInput = document.getElementById("newBreederInput");
        const indicaSativaSlider = document.getElementById("indicaSativaSlider");
        const indicaLabel = document.getElementById("indicaLabel");
        const sativaLabel = document.getElementById("sativaLabel");

        // Show/Hide New Breeder Input
        breederSelect.addEventListener("change", () => {
            if (breederSelect.value === "new") {
                newBreederInput.classList.remove("d-none");
            } else {
                newBreederInput.classList.add("d-none");
            }
        });

        // Update labels dynamically as the slider changes
        indicaSativaSlider.addEventListener("input", (e) => {
            const indica = e.target.value;
            const sativa = 100 - indica;
            indicaLabel.textContent = `Indica: ${indica}%`;
            sativaLabel.textContent = `Sativa: ${sativa}%`;
        });

        addStrainForm.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const payload = {
                name: document.getElementById("strainName").value,
                breeder_id: breederSelect.value === "new" ? null : parseInt(breederSelect.value, 10),
                new_breeder: breederSelect.value === "new" ? document.getElementById("newBreederName").value : null,
                indica: parseInt(indicaSativaSlider.value, 10),
                sativa: 100 - parseInt(indicaSativaSlider.value, 10),
                autoflower: document.getElementById("autoflower").value,
                seed_count: parseInt(document.getElementById("seedCount").value, 10),
                description: document.getElementById("strainDescription").value,
            };

            // Send POST request to add the strain
            fetch("/strains", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add strain");
                    }
                    return response.json();
                })
                .then((data) => {
                    location.reload(); // Reload the page to show the new strain
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred while adding the strain.");
                });
        });
    });
    document.addEventListener("DOMContentLoaded", () => {
        const editStrainModal = new bootstrap.Modal(document.getElementById("editStrainModal"));
        const editStrainForm = document.getElementById("editStrainForm");
        const deleteStrainButton = document.getElementById("deleteStrainButton");
        const editBreederSelect = document.getElementById("editBreederSelect");
        const editNewBreederInput = document.getElementById("editNewBreederInput");
        const editIndicaSativaSlider = document.getElementById("editIndicaSativaSlider");
        const editIndicaLabel = document.getElementById("editIndicaLabel");
        const editSativaLabel = document.getElementById("editSativaLabel");

        // Show/Hide New Breeder Input
        editBreederSelect.addEventListener("change", () => {
            if (editBreederSelect.value === "new") {
                editNewBreederInput.classList.remove("d-none");
            } else {
                editNewBreederInput.classList.add("d-none");
            }
        });

        // Update Indica/Sativa labels dynamically
        editIndicaSativaSlider.addEventListener("input", () => {
            const indica = editIndicaSativaSlider.value;
            const sativa = 100 - indica;
            editIndicaLabel.textContent = `Indica: ${indica}%`;
            editSativaLabel.textContent = `Sativa: ${sativa}%`;
        });

        // Populate modal fields when editing
        document.querySelectorAll(".clickable-row").forEach(row => {
            row.addEventListener("click", () => {
                const strainData = JSON.parse(row.getAttribute("data-strain"));

                // Populate form fields
                document.getElementById("editStrainId").value = strainData.id;
                document.getElementById("editStrainName").value = strainData.name;

                // Pre-select breeder in dropdown
                editBreederSelect.value = strainData.breeder_id || "new";

                // Show/hide new breeder input based on selection
                if (strainData.breeder_id) {
                    editNewBreederInput.classList.add("d-none");
                    document.getElementById("editNewBreederName").value = "";
                } else {
                    editNewBreederInput.classList.remove("d-none");
                    document.getElementById("editNewBreederName").value = strainData.new_breeder || "";
                }

                document.getElementById("editIndicaSativaSlider").value = strainData.indica;
                editIndicaLabel.textContent = `Indica: ${strainData.indica}%`;
                editSativaLabel.textContent = `Sativa: ${100 - strainData.indica}%`;
                document.getElementById("editAutoflower").value = strainData.autoflower;
                document.getElementById("editSeedCount").value = strainData.seed_count;
                document.getElementById("editStrainDescription").value = strainData.description;

                // Show the modal
                editStrainModal.show();
            });
        });

        // Handle form submission
        editStrainForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const strainId = document.getElementById("editStrainId").value;
            const payload = {
                name: document.getElementById("editStrainName").value,
                breeder_id: editBreederSelect.value === "new" ? null : parseInt(editBreederSelect.value, 10),
                new_breeder: editBreederSelect.value === "new" ? document.getElementById("editNewBreederName").value : null,
                indica: parseInt(editIndicaSativaSlider.value, 10),
                sativa: 100 - parseInt(editIndicaSativaSlider.value, 10),
                autoflower: document.getElementById("editAutoflower").value,
                seed_count: parseInt(document.getElementById("editSeedCount").value, 10),
                description: document.getElementById("editStrainDescription").value,
            };

            fetch(`/strains/${strainId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to update strain");
                    location.reload();
                })
                .catch(error => {
                    console.error("Error updating strain:", error);
                    alert("Failed to update strain.");
                });
        });

        // Handle strain deletion
        deleteStrainButton.addEventListener("click", () => {
            const strainId = document.getElementById("editStrainId").value;

            if (confirm("Are you sure you want to delete this strain?")) {
                fetch(`/strains/${strainId}`, { method: "DELETE" })
                    .then(response => {
                        if (!response.ok) throw new Error("Failed to delete strain");
                        location.reload();
                    })
                    .catch(error => {
                        console.error("Error deleting strain:", error);
                        alert("Failed to delete strain.");
                    });
            }
        });
    });



    document.addEventListener("DOMContentLoaded", () => {
        // Listen for when any modal is hidden
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('hidden.bs.modal', () => {
                // Remove lingering modal-backdrop elements
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());

                // Ensure the body class does not remain disabled
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            });
        });
    });

</script>



<!--Embed the footer.html template at this location-->
{{ template "layouts/footer.html" .}}

{{ end }}