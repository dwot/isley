{{ define "views/plant.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "layouts/header.html" .}}
<style>
    .clickable-row {
        cursor: pointer;
    }

    .clickable-row:hover {
        background-color: #f8f9fa; /* Optional: Light background on hover */
    }
    .thumbnail-img {
        cursor: pointer;
        object-fit: cover;
        height: 150px;
        width: 100%;
        transition: transform 0.2s;
    }

    .thumbnail-img:hover {
        transform: scale(1.05);
    }
    #dropArea {
        cursor: pointer;
        background-color: #f8f9fa;
        transition: background-color 0.3s;
    }

    #dropArea.border-success {
        background-color: #d4edda;
    }
    .spinner-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 1056; /* Higher than Bootstrap's modal (1055 for modal content) */
     }
    #shareOptions a {
        display: inline-block;
        margin: 0.5em 0;
    }
    #shareOptions {
        text-align: center;
    }
</style>
{{ template "layouts/header2.html" .}}
<div class="container">
    <!-- Page Title -->
    <div class="text-center mb-5">
        <h1 class="display-4 text-primary">{{ .plant.Name }}</h1>
        <p class="text-muted">{{ .plant.Description }}</p>
    </div>

    <div class="text-center mb-5">
        <div class="row g-4">
            <!-- Latest Image Section -->
            <div class="col-md-6">
                <div class="card">
                    <img
                            src="{{ .plant.LatestImage.ImagePath }}"
                            class="card-img-top"
                            alt="{{ .plant.LatestImage.ImageDescription }}"
                            style="max-height: 300px; object-fit: cover;"
                    >
                    <div class="card-body text-center">
                        <p class="card-text text-muted">{{ .plant.LatestImage.ImageDescription }}</p>
                        <small class="text-muted">Taken on {{ formatDate .plant.LatestImage.ImageDate }}</small>
                    </div>
                </div>
            </div>

            <!-- Plant Details Section -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body text-start">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title text-primary">Plant Details</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changeStatusModal">
                                <i class="fa-solid fa-pen-to-square"></i> Plant
                            </button>

                            <button class="btn btn-danger" id="deletePlantButton">
                                <i class="fa-solid fa-trash"></i> Plant
                            </button>
                        </div>
                        <ul class="list-unstyled">
                            <li><strong>Status:</strong> {{ .plant.Status }}</li>
                            <li><strong>Strain:</strong> {{ .plant.StrainName }} (by {{ .plant.BreederName }})</li>
                            <li><strong>Zone:</strong> {{ .plant.ZoneName }}</li>
                            <li><strong>Day:</strong> {{ .plant.CurrentDay }}</li>
                            <li><strong>Week:</strong> {{ .plant.CurrentWeek }}</li>
                            <li><strong>Start Date:</strong> {{ formatDate .plant.StartDT }}</li>
                            {{if ne (formatDate .plant.HeightDate) "01/01/1970" }}
                            <li><strong>Height:</strong> {{ .plant.CurrentHeight }}" - {{ formatDate .plant.HeightDate }}</li>

                            </li>
                            {{end}}

                            {{if or (ne (formatDate .plant.LastWaterDate) "01/01/1970") (ne (formatDate .plant.LastFeedDate) "01/01/1970") }}
                            <li><strong>Last Watered or Fed:</strong>
                                {{if gt (formatDate .plant.LastWaterDate) (formatDate .plant.LastFeedDate)}}
                                {{ formatDate .plant.LastWaterDate }} (Watered)
                                {{else}}
                                {{ formatDate .plant.LastFeedDate }} (Fed)
                                {{end}}
                            </li>
                            {{end}}
                        </ul>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-around">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">
                                <i class="fa-solid fa-plus"></i> Add Measurement
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                                <i class="fa-solid fa-plus"></i> Add Activity
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImagesModal">
                                <i class="fa-solid fa-plus"></i> Upload Images
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="plantDetailsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button" role="tab" aria-controls="sensors" aria-selected="false">
                Sensors
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="false">
                Status History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="measurements-tab" data-bs-toggle="tab" data-bs-target="#measurements" type="button" role="tab" aria-controls="measurements" aria-selected="false">
                Measurements
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="false">
                Activities
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button" role="tab" aria-controls="gallery" aria-selected="false">
                Image Gallery
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="plantDetailsTabsContent">
        <!-- Sensors Tab -->
        <div class="tab-pane fade show active" id="sensors" role="tabpanel" aria-labelledby="sensors-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Sensors</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linkSensorModal">
                    <i class="fa-solid fa-link"></i> Link Sensors
                </button>
            </div>
            <div class="row g-4">
                {{ range .plant.Sensors }}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <a href="/graph/{{.ID}}" class="text-decoration-none">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ .Name }}</h5>
                                <p class="display-6 fw-bold">{{ .Value }} {{ .Unit }}</p>
                                <small class="text-muted">{{ formatDate .Date }}</small>
                            </div>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Status History Tab -->
        <div class="tab-pane fade" id="status" role="tabpanel" aria-labelledby="status-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Status History</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.StatusHistory }}
                <tr class="clickable-row status-row" data-status='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Status }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Measurements Tab -->
        <div class="tab-pane fade" id="measurements" role="tabpanel" aria-labelledby="measurements-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Measurements</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Measurement</th>
                    <th>Value</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Measurements }}
                <tr class="clickable-row measurement-row" data-measurement='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ .Value }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Activities Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Activities</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Activity</th>
                    <th>Note</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Activities }}
                <tr class="clickable-row activity-row" data-activity='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ preview .Note }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Image Gallery Tab -->
        <div class="tab-pane fade" id="gallery" role="tabpanel" aria-labelledby="gallery-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Image Gallery</h3>
            </div>
            <div class="row g-3">
                {{ range .plant.Images }}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card">
                        <img
                                src="{{ .ImagePath }}"
                                class="card-img-top thumbnail-img"
                                alt="{{ .ImageDescription }}"
                                data-bs-toggle="modal"
                                data-bs-target="#imageModal"
                                data-image="{{ .ImagePath }}"
                                data-description="{{ .ImageDescription }}"
                                data-date="{{ formatDate .ImageDate }}"
                        >
                        <div class="card-body text-center">
                            <small class="text-muted">{{ formatDate .ImageDate }}</small>
                        </div>
                    </div>
                </div>
                {{ end }}
            </div>
        </div>
    </div>
</div>

<!-- Upload Images Modal -->
<div class="modal fade" id="uploadImagesModal" tabindex="-1" aria-labelledby="uploadImagesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadImagesModalLabel">Upload Images</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Drag-and-Drop Area -->
                <div id="dropArea" class="border border-primary rounded p-4 text-center mb-3">
                    <p>Drag and drop images here or click to browse</p>
                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                </div>
                <div id="imagePreviewContainer" class="row g-3">
                    <!-- Preview cards for uploaded images will be appended here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="uploadImagesButton">Upload Images</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Full-size image">
                <p class="mt-3 text-muted" id="modalDescription"></p>
                <small class="text-muted" id="modalDate"></small>
                <div class="mt-4">
                    <button id="decorateImage" class="btn btn-primary">
                        <i class="fa fa-magic"></i> Magic Wand
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Link Sensor Modal -->
<div class="modal fade" id="linkSensorModal" tabindex="-1" aria-labelledby="linkSensorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkSensorModalLabel">Link Sensors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="linkSensorForm">
                    <table class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Select</th>
                            <th>Sensor Name</th>
                            <th>Source</th>
                            <th>Device</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{ range .sensors }}
                        <tr>
                            <td>
                                <input
                                        type="checkbox"
                                        class="form-check-input"
                                        name="sensorIds"
                                        value="{{ index . "id" }}"
                                {{ $sensorId := index . "id" }}
                                {{ range $.plant.Sensors }}
                                {{ if eq (toInt $sensorId) .ID }}checked{{ end }}
                                {{ end }}
                                >
                            </td>
                            <td>{{ index . "name" }}</td>
                            <td>{{ index . "source" }}</td>
                            <td>{{ index . "device" }}</td>
                        </tr>
                        {{ end }}

                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary">Link Sensors</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Change Status Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeStatusModalLabel">Update Plant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changeStatusForm">
                    <!-- Status Dropdown -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" required>
                            {{ range .statuses }}
                            <option
                                    {{ if eq .ID $.plant.StatusID }}selected{{ end }}
                                    value="{{ .ID }}">{{ .Status }}</option>
                            {{ end }}
                        </select>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="statusDate" class="form-label">Effective Date</label>
                        <input type="date" class="form-control" id="statusDate" required>
                    </div>

                    <!-- Plant Name -->
                    <div class="mb-3">
                        <label for="plantName" class="form-label">Plant Name</label>
                        <input type="text" class="form-control" id="plantName" value="{{ .plant.Name }}">
                    </div>

                    <!-- Start Date -->
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" value="{{ .plant.StartDT | formatDateISO }}">
                    </div>

                    <!-- Plant Description -->
                    <div class="mb-3">
                        <label for="plantDescription" class="form-label">Plant Description</label>
                        <textarea class="form-control" id="plantDescription" rows="3">{{ .plant.Description }}</textarea>
                    </div>

                    <!-- Plant Strain -->
                    <!-- Strain Dropdown -->
                    <div class="mb-3">
                        <label for="strainSelect" class="form-label">Strain</label>
                        <select class="form-select" id="strainSelect" required>
                            {{ range .strains }}
                            <option
                                    {{ if eq .ID $.plant.StrainID }}selected{{ end }}
                                    value="{{ .ID }}">{{ .Name }} ({{ .Breeder }})</option>
                            {{ end }}
                            <option value="new">Add New Strain</option>
                        </select>
                    </div>

                    <!-- New Strain Inputs -->
                    <div class="mb-3 d-none" id="newStrainInputs">
                        <label for="newStrainName" class="form-label">Strain Name</label>
                        <input type="text" class="form-control" id="newStrainName" placeholder="Enter Strain Name">

                        <!-- Breeder Dropdown -->
                        <div class="mb-3">
                            <label for="breederSelect" class="form-label">Breeder</label>
                            <select class="form-select" id="breederSelect">
                                {{ range .breeders }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                                <option value="new">Add New Breeder</option>
                            </select>
                        </div>

                        <!-- New Breeder Input -->
                        <div class="mb-3 d-none" id="newBreederInput">
                            <label for="newBreederName" class="form-label">New Breeder Name</label>
                            <input type="text" class="form-control" id="newBreederName" placeholder="Enter Breeder Name">
                        </div>
                    </div>

                    <!-- Clone Checkbox -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="cloneCheckbox"
                        {{ if .plant.IsClone }}checked{{ end }}
                        >
                        <label class="form-check-label" for="cloneCheckbox">This plant is a clone</label>
                    </div>

                    <!-- Zone Dropdown -->
                    <div class="mb-3">
                        <label for="zoneSelect" class="form-label">Zone</label>
                        <select class="form-select" id="zoneSelect" required>
                            {{ range .zones }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">Add New Zone</option>
                        </select>
                    </div>

                    <!-- New Zone Input -->
                    <div class="mb-3 d-none" id="newZoneInput">
                        <label for="newZoneName" class="form-label">New Zone Name</label>
                        <input type="text" class="form-control" id="newZoneName" placeholder="Enter Zone Name">
                    </div>

                    <!-- Plant ID (Hidden Input) -->
                    <input type="hidden" id="plantId" value="{{ .plant.ID }}">

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Change Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Measurement Modal -->
<div class="modal fade" id="addMeasurementModal" tabindex="-1" aria-labelledby="addMeasurementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMeasurementModalLabel">Add Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMeasurementForm">
                    <!-- Metric Name Dropdown -->
                    <div class="mb-3">
                        <label for="measurementName" class="form-label">Measurement Name</label>
                        <select class="form-select" id="measurementName" required>
                            {{ range .measurements }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <!-- Metric Value Input -->
                    <div class="mb-3">
                        <label for="measurementValue" class="form-label">Measurement Value</label>
                        <input type="number" class="form-control" id="measurementValue" step="any" required>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="measureDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="measureDate" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Measurement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Activity Modal -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-labelledby="addActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addActivityModalLabel">Add Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addActivityForm">
                    <!-- Activity Name Dropdown -->
                    <div class="mb-3">
                        <label for="activityName" class="form-label">Activity Name</label>
                        <select class="form-select" id="activityName" required>
                            {{ range .activities }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <!-- Activity Note Input -->
                    <div class="mb-3">
                        <label for="activityNote" class="form-label">Activity Note</label>
                        <textarea class="form-control" id="activityNote" rows="3"></textarea>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="activityDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="activityDate" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Activity</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Status History Edit Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStatusModalLabel">Edit Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStatusForm">
                    <input type="hidden" id="statusId">
                    <div class="mb-3">
                        <label for="editStatusDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editStatusDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteStatus"><i class="fa-solid fa-trash"></i> Delete Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Measurement Edit Modal -->
<div class="modal fade" id="editMeasurementModal" tabindex="-1" aria-labelledby="editMeasurementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMeasurementModalLabel">Edit Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMeasurementForm">
                    <input type="hidden" id="measurementId">
                    <div class="mb-3">
                        <label for="editMeasurementDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editMeasurementDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMeasurementValue" class="form-label">Value</label>
                        <input type="number" class="form-control" id="editMeasurementValue" step="any" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteMeasurement"><i class="fa-solid fa-trash"></i> Delete Measurement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activity Edit Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1" aria-labelledby="editActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editActivityModalLabel">Edit Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm">
                    <input type="hidden" id="activityId">
                    <div class="mb-3">
                        <label for="editActivityDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editActivityDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editActivityType" class="form-label">Type</label>
                        <select class="form-select" id="editActivityType" required>
                            {{ range .activities }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editActivityNote" class="form-label">Note</label>
                        <textarea class="form-control" id="editActivityNote" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteActivity"><i class="fa-solid fa-trash"></i> Delete Activity</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("addMeasurementForm");
        const addMeasurementModal = document.getElementById("addMeasurementModal");
        const measurementDateInput = document.getElementById("measureDate");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            measurementDateInput.value = today;
        };

        // Set default date when the modal is shown
        addMeasurementModal.addEventListener("show.bs.modal", setDefaultDate);

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const metricId = document.getElementById("measurementName").value;
            const value = document.getElementById("measurementValue").value;
            const date = measurementDateInput.value;

            // Construct the payload
            const payload = {
                plant_id: parseInt(plantId, 10),
                metric_id: parseInt(metricId, 10),
                value: parseFloat(value),
                date: date,
            };

            // Send POST request to /plantMeasurement
            fetch("/plantMeasurement", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add measurement");
                    }
                    return response.json();
                })
                .then((data) => {
                    // Success: Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addMeasurementModal"));
                    modal.hide();
                    window.location.reload(); // Refresh page to show updated data
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add measurement. Please try again.");
                });
        });
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("addActivityForm");
        const addActivityModal = document.getElementById("addActivityModal");
        const activityDateInput = document.getElementById("activityDate");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            activityDateInput.value = today;
        };

        // Set default date when the modal is shown
        addActivityModal.addEventListener("show.bs.modal", setDefaultDate);

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const activityId = document.getElementById("activityName").value;
            const activityNote = document.getElementById("activityNote").value;
            const date = activityDateInput.value;

            // Construct the payload
            const payload = {
                plant_id: parseInt(plantId, 10),
                activity_id: parseInt(activityId, 10),
                note: activityNote,
                date: date,
            };

            // Send POST request to /plantActivity
            fetch("/plantActivity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add activity");
                    }
                    return response.json();
                })
                .then((data) => {
                    // Success: Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addActivityModal"));
                    modal.hide();
                    window.location.reload(); // Refresh page to show updated data
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add activity. Please try again.");
                });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const changeStatusModal = document.getElementById("changeStatusModal");
        const statusDateInput = document.getElementById("statusDate");
        const zoneSelect = document.getElementById("zoneSelect");
        const newZoneInput = document.getElementById("newZoneInput");
        const strainSelect = document.getElementById("strainSelect");
        const newStrainInputs = document.getElementById("newStrainInputs");
        const breederSelect = document.getElementById("breederSelect");
        const newBreederInput = document.getElementById("newBreederInput");
        const newZoneName = document.getElementById("newZoneName");
        const newStrainName = document.getElementById("newStrainName");
        const newBreederName = document.getElementById("newBreederName");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            statusDateInput.value = today;
        };

        // Reset Zone Selection
        const resetZoneSelection = () => {
            zoneSelect.disabled = false;
            zoneSelect.value = "";
            newZoneInput.classList.add("d-none");
        };

        // Reset Strain Selection
        const resetStrainSelection = () => {
            strainSelect.value = "";
            newStrainInputs.classList.add("d-none");
            resetBreederSelection();
        };

        // Reset Breeder Selection
        const resetBreederSelection = () => {
            breederSelect.value = "";
            newBreederInput.classList.add("d-none");
        };


        // Set default date when the modal is shown
        changeStatusModal.addEventListener("show.bs.modal", () => {
            setDefaultDate();
        });

        // Show/Hide New Zone Input
        zoneSelect.addEventListener("change", () => {
            if (zoneSelect.value === "new") {
                newZoneInput.classList.remove("d-none");
            } else {
                newZoneInput.classList.add("d-none");
            }
        });

        // Show/Hide New Strain Inputs
        strainSelect.addEventListener("change", () => {
            if (strainSelect.value === "new") {
                newStrainInputs.classList.remove("d-none");
            } else {
                newStrainInputs.classList.add("d-none");
            }
        });

        // Show/Hide New Breeder Input
        breederSelect.addEventListener("change", () => {
            if (breederSelect.value === "new") {
                newBreederInput.classList.remove("d-none");
            } else {
                newBreederInput.classList.add("d-none");
            }
        });

        // Handle form submission
        const changeStatusForm = document.getElementById("changeStatusForm");
        changeStatusForm.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const status = document.getElementById("status").value;
            const date = statusDateInput.value;
            const startDate = document.getElementById("startDate").value;

            const payload = {
                plant_id: parseInt(plantId, 10),
                plant_name: document.getElementById("plantName").value,
                plant_description: document.getElementById("plantDescription").value,
                status_id: parseInt(status, 10),
                date: date,
                zone_id: parseInt(zoneSelect.value, 10),
                new_zone: newZoneName.value,
                strain_id: parseInt(strainSelect.value, 10),
                new_strain: strainSelect.value === "new" ? {
                    name: newStrainName.value,
                    breeder_id: breederSelect.value === "new" ? null : parseInt(breederSelect.value, 10),
                    new_breeder: breederSelect.value === "new" ? newBreederName.value : null
                } : null,
                clone: document.getElementById("cloneCheckbox").checked,
                start_date: startDate,
            };

            //alert(JSON.stringify(payload));

            // Send POST request to change status
            fetch("/plant", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to change status");
                    }
                    return response.json();
                })
                .then(data => {
                    //alert("Status changed successfully!");
                    location.reload(); // Reload the page to reflect changes
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to change status. Please try again.");
                });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Handle Linking Sensors
        const linkSensorForm = document.getElementById("linkSensorForm");
        linkSensorForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const plantId = document.getElementById("plantId").value;
            const formData = new FormData(linkSensorForm);
            const sensorIds = formData.getAll("sensorIds").map(id => parseInt(id, 10));
            const payload = {
                plant_id: plantId,
                sensor_ids: sensorIds
        };

            fetch("/plant/link-sensors", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to link sensors");
                    //alert("Sensors linked successfully!");
                    location.reload();
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to link sensors. Please try again.");
                });
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editMeasurementModal = new bootstrap.Modal(document.getElementById("editMeasurementModal"));
        const measurementForm = document.getElementById("editMeasurementForm");
        const deleteMeasurementButton = document.getElementById("deleteMeasurement");

        document.querySelectorAll(".measurement-row").forEach(row => {
            row.addEventListener("click", () => {
                const measurementData = JSON.parse(row.getAttribute("data-measurement"));

                document.getElementById("measurementId").value = measurementData.id;
                const formattedDate = measurementData.date.split("T")[0];
                document.getElementById("editMeasurementDate").value = formattedDate;
                document.getElementById("editMeasurementValue").value = measurementData.value;

                editMeasurementModal.show();
            });
        });

        measurementForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("measurementId").value, 10),
                date: document.getElementById("editMeasurementDate").value,
                value: parseFloat(document.getElementById("editMeasurementValue").value),
            };

            fetch("/plantMeasurement/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update measurement"));
        });

        deleteMeasurementButton.addEventListener("click", () => {
            const measurementId = document.getElementById("measurementId").value;

            if (confirm("Are you sure you want to delete this measurement?")) {
                fetch(`/plantMeasurement/delete/${measurementId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete measurement"));
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editStatusModal = new bootstrap.Modal(document.getElementById("editStatusModal"));
        const statusForm = document.getElementById("editStatusForm");
        const deleteStatusButton = document.getElementById("deleteStatus");

        document.querySelectorAll(".status-row").forEach(row => {
            row.addEventListener("click", () => {
                const statusData = JSON.parse(row.getAttribute("data-status"));

                document.getElementById("statusId").value = statusData.id;
                const formattedDate = statusData.date.split("T")[0];
                document.getElementById("editStatusDate").value = formattedDate;

                editStatusModal.show();
            });
        });

        statusForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("statusId").value, 10),
                date: document.getElementById("editStatusDate").value,
            };

            fetch("/plantStatus/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update status history"));
        });

        deleteStatusButton.addEventListener("click", () => {
            const statusId = document.getElementById("statusId").value;

            if (confirm("Are you sure you want to delete this status?")) {
                fetch(`/plantStatus/delete/${statusId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete status history"));
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editActivityModal = new bootstrap.Modal(document.getElementById("editActivityModal"));
        const activityForm = document.getElementById("editActivityForm");
        const deleteActivityButton = document.getElementById("deleteActivity");

        document.querySelectorAll(".activity-row").forEach(row => {
            row.addEventListener("click", () => {
                const activityData = JSON.parse(row.getAttribute("data-activity"));

                document.getElementById("activityId").value = activityData.id;
                const formattedDate = activityData.date.split("T")[0];
                document.getElementById("editActivityDate").value = formattedDate;
                document.getElementById("editActivityType").value = activityData.activity_id;
                document.getElementById("editActivityNote").value = activityData.note;

                editActivityModal.show();
            });
        });

        activityForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("activityId").value, 10),
                date: document.getElementById("editActivityDate").value,
                activity_id: parseInt(document.getElementById("editActivityType").value, 10),
                note: document.getElementById("editActivityNote").value,
            };

            fetch("/plantActivity/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update activity"));
        });

        deleteActivityButton.addEventListener("click", () => {
            const activityId = document.getElementById("activityId").value;

            if (confirm("Are you sure you want to delete this activity?")) {
                fetch(`/plantActivity/delete/${activityId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete activity"));
            }
        });

        deletePlantButton.addEventListener("click", () => {
            const plantId = document.getElementById("plantId").value;

            if (confirm("Are you sure you want to delete this plant?")) {
                fetch(`/plant/delete/${plantId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.href = "/plants")
                    .catch(err => alert("Failed to delete plant"));
            }
        })
    });

    document.addEventListener("DOMContentLoaded", () => {
        const imageModal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");
        const modalDescription = document.getElementById("modalDescription");
        const modalDate = document.getElementById("modalDate");

        document.querySelectorAll(".thumbnail-img").forEach((img) => {
            img.addEventListener("click", () => {
                modalImage.src = img.dataset.image;
                modalDescription.textContent = img.dataset.description;
                modalDate.textContent = img.dataset.date;
            });
        });
    });

</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const dropArea = document.getElementById("dropArea");
        const imageInput = document.getElementById("imageInput");
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        const uploadImagesButton = document.getElementById("uploadImagesButton");

        let imagesToUpload = [];

        // Handle drag-and-drop events
        ["dragenter", "dragover"].forEach(eventType => {
            dropArea.addEventListener(eventType, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.add("border-success");
            });
        });

        ["dragleave", "drop"].forEach(eventType => {
            dropArea.addEventListener(eventType, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.remove("border-success");
            });
        });

        // Handle drop event
        dropArea.addEventListener("drop", (e) => {
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // Handle click to browse
        dropArea.addEventListener("click", () => {
            imageInput.click();
        });

        imageInput.addEventListener("change", () => {
            const files = Array.from(imageInput.files);
            handleFiles(files);
        });

        // Process selected files
        function handleFiles(files) {
            files.forEach((file) => {
                if (!file.type.startsWith("image/")) {
                    alert("Only image files are allowed!");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    addImagePreview(e.target.result, file);
                };
                reader.readAsDataURL(file);
                imagesToUpload.push(file);
            });
        }

        // Add image preview
        function addImagePreview(src, file) {
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 col-lg-4";

            const card = `
                <div class="card">
                    <img src="${src}" class="card-img-top" alt="Preview">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control description" placeholder="Enter description">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control image-date" value="${new Date().toISOString().split("T")[0]}">
                        </div>
                    </div>
                </div>
            `;

            col.innerHTML = card;
            imagePreviewContainer.appendChild(col);
        }

        // Handle upload
        uploadImagesButton.addEventListener("click", () => {
            const formData = new FormData();

            // Collect data for each image
            document.querySelectorAll("#imagePreviewContainer .card").forEach((card, index) => {
                const description = card.querySelector(".description").value;
                const date = card.querySelector(".image-date").value;

                // Append the file with a simple key
                formData.append("images[]", imagesToUpload[index]);
                formData.append(`descriptions[]`, description);
                formData.append(`dates[]`, date);
            });

            const plantId = document.getElementById("plantId").value;
            fetch(`/plant/${plantId}/images/upload`, {
                method: "POST",
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to upload images");
                    }
                    return response.json();
                })
                .then((data) => {
                    //alert("Images uploaded successfully!");
                    location.reload();
                })
                .catch((error) => {
                    console.error("Error uploading images:", error);
                    alert("An error occurred while uploading images.");
                });
        });

    });
</script>

<script>
    function confirmDeleteImage(imageId, imagePath) {
        if (confirm("Are you sure you want to delete this image?")) {
            fetch(`/plant/images/${imageId}/delete`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to delete image");
                    }
                    return response.json();
                })
                .then((data) => {
                    alert("Image deleted successfully!");
                    // Reload the page to reflect changes
                    location.reload();
                })
                .catch((error) => {
                    console.error("Error deleting image:", error);
                    alert("An error occurred while deleting the image.");
                });
        }
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const decorateImageButton = document.getElementById("decorateImage");
        const modalImage = document.getElementById("modalImage");

        decorateImageButton.addEventListener("click", () => {
            const fullImagePath = modalImage.src; // Full URL (e.g., http://localhost:8080/uploads/plants/plant_1_image_0.jpg)

            // Extract the relative path
            const imagePath = new URL(fullImagePath).pathname.replace(/^\//, ""); // Removes the leading slash
            const strainName = document.getElementById("strainName").value; // Assume strainName exists
            const plantAge = document.getElementById("currentDay").value; // Assume currentDay exists

            // Add a spinner overlay inside the modal
            const modal = document.getElementById("imageModal");
            const spinnerOverlay = document.createElement("div");
            spinnerOverlay.id = "spinnerOverlay";
            spinnerOverlay.innerHTML = `
                <div class="spinner-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            modal.appendChild(spinnerOverlay);


            // Send a POST request to the backend for decoration
            fetch("/decorateImage", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    imagePath,
                    strainName,
                    plantAge,
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Replace modal image with the decorated version
                        modalImage.src = "../" + data.outputPath;
                    } else {
                        alert("Failed to decorate image: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error decorating image:", error);
                })
                .finally(() => {
                    // Remove the spinner overlay
                    const spinner = document.getElementById("spinnerOverlay");
                    if (spinner) spinner.remove();
                });
        });
    });

</script>

<!--Embed the footer.html template at this location-->
{{ template "layouts/footer.html" .}}

{{ end }}