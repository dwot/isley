{{ define "views/plant.html"}}
<!--index.html-->

<!--Embed the header.html template at this location-->
{{ template "layouts/header.html" .}}
<style>
    .clickable-row {
        cursor: pointer;
    }

    .clickable-row:hover {
        background-color: #f8f9fa; /* Optional: Light background on hover */
    }
    .thumbnail-img {
        cursor: pointer;
        object-fit: cover;
        height: 150px;
        width: 100%;
        transition: transform 0.2s;
    }

    .thumbnail-img:hover {
        transform: scale(1.05);
    }
    #dropArea {
        cursor: pointer;
        background-color: #f8f9fa;
        transition: background-color 0.3s;
    }

    #dropArea.border-success {
        background-color: #d4edda;
    }
    .spinner-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 1056; /* Higher than Bootstrap's modal (1055 for modal content) */
     }
    #shareOptions a {
        display: inline-block;
        margin: 0.5em 0;
    }
    #shareOptions {
        text-align: center;
    }
</style>
{{ template "layouts/header2.html" .}}
<div class="container">
    <!-- Page Title -->
    <div class="text-center mb-5">
        <h1 class="display-4 text-primary">{{ .plant.Name }}</h1>
        <p class="text-muted">{{ .plant.Description }}</p>
    </div>

    <div class="text-center mb-5">
        <div class="row g-4">
            <!-- Latest Image Section -->
            <div class="col-md-6">
                <div class="card">
                    <img
                            src="{{ .plant.LatestImage.ImagePath }}"
                            class="card-img-top"
                            alt="{{ .plant.LatestImage.ImageDescription }}"
                            style="max-height: 300px; object-fit: cover;"
                    >
                    <div class="card-body text-center">
                        <p class="card-text text-muted">{{ .plant.LatestImage.ImageDescription }}</p>
                        <small class="text-muted">Taken on {{ formatDate .plant.LatestImage.ImageDate }}</small>
                    </div>
                </div>
            </div>

            <!-- Plant Details Section -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body text-start">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title text-primary">Plant Details</h5>
                            <div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changeStatusModal">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="btn btn-danger" id="deletePlantButton">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="strainName" value="{{ .plant.StrainName }}">
                        <input type="hidden" id="breederName" value="{{ .plant.BreederName }}">
                        <input type="hidden" id="currentDay" value="{{ .plant.CurrentDay }}">
                        <input type="hidden" id="currentWeek" value="{{ .plant.CurrentWeek }}">

                        <ul class="list-unstyled">
                            <li><strong>Status:</strong> {{ .plant.Status }}</li>
                            <li><strong>Strain:</strong> {{ .plant.StrainName }} (by {{ .plant.BreederName }})</li>
                            <li><strong>Zone:</strong> {{ .plant.ZoneName }}</li>
                            <li><strong>Start Date:</strong> {{ formatDate .plant.StartDT }}</li>

                            <!-- Conditional: If Plant is Harvested or Dead -->
                            {{ if or (eq .plant.Status "Success") (eq .plant.Status "Drying") (eq .plant.Status "Curing") (eq .plant.Status "Dead") }}
                            <li><strong>Harvest Date:</strong> {{ formatDate .plant.HarvestDate }}</li>
                            <li><strong>Harvest Weight:</strong> {{ .plant.HarvestWeight }} grams</li>
                            {{ else }}
                            <li><strong>Day:</strong> {{ .plant.CurrentDay }}</li>
                            <li><strong>Week:</strong> {{ .plant.CurrentWeek }}</li>
                            {{ end }}

                            <!-- Optional: Height -->
                            {{ if ne (formatDate .plant.HeightDate) "01/01/1970" }}
                            <li><strong>Height:</strong> {{ .plant.CurrentHeight }}" - {{ formatDate .plant.HeightDate }}</li>
                            {{ end }}

                            <!-- Optional: Last Watered or Fed -->
                            {{ if or (ne (formatDate .plant.LastWaterDate) "01/01/1970") (ne (formatDate .plant.LastFeedDate) "01/01/1970") }}
                            <li><strong>Last Watered or Fed:</strong>
                                {{ if gt (formatDate .plant.LastWaterDate) (formatDate .plant.LastFeedDate) }}
                                {{ formatDate .plant.LastWaterDate }} (Watered)
                                {{ else }}
                                {{ formatDate .plant.LastFeedDate }} (Fed)
                                {{ end }}
                            </li>
                            {{ end }}
                        </ul>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="card">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-around">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">
                                <i class="fa-solid fa-plus"></i> Add Measurement
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                                <i class="fa-solid fa-plus"></i> Add Activity
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImagesModal">
                                <i class="fa-solid fa-plus"></i> Upload Images
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="plantDetailsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button" role="tab" aria-controls="sensors" aria-selected="false">
                Sensors
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="statusHistoryTab-tab" data-bs-toggle="tab" data-bs-target="#statusHistoryTab" type="button" role="tab" aria-controls="statusHistoryTab" aria-selected="false">
                Status History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="measurements-tab" data-bs-toggle="tab" data-bs-target="#measurements" type="button" role="tab" aria-controls="measurements" aria-selected="false">
                Measurements
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="false">
                Activities
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button" role="tab" aria-controls="gallery" aria-selected="false">
                Image Gallery
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="plantDetailsTabsContent">
        <!-- Sensors Tab -->
        <div class="tab-pane fade show active" id="sensors" role="tabpanel" aria-labelledby="sensors-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Sensors</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#linkSensorModal">
                    <i class="fa-solid fa-link"></i> Link Sensors
                </button>
            </div>
            <div class="row g-4">
                {{ range .plant.Sensors }}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <a href="/graph/{{.ID}}" class="text-decoration-none">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">{{ .Name }}</h5>
                                <p class="display-6 fw-bold">{{ .Value }} {{ .Unit }}</p>
                                <small class="text-muted">{{ formatDate .Date }}</small>
                            </div>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Status History Tab -->
        <div class="tab-pane fade" id="statusHistoryTab" role="tabpanel" aria-labelledby="status-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Status History</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.StatusHistory }}
                <tr class="clickable-row status-row" data-status='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Status }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Measurements Tab -->
        <div class="tab-pane fade" id="measurements" role="tabpanel" aria-labelledby="measurements-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Measurements</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Measurement</th>
                    <th>Value</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Measurements }}
                <tr class="clickable-row measurement-row" data-measurement='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ .Value }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Activities Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Activities</h3>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Activity</th>
                    <th>Note</th>
                </tr>
                </thead>
                <tbody>
                {{ range .plant.Activities }}
                <tr class="clickable-row activity-row" data-activity='{{ json . }}'>
                    <td>{{ formatDate .Date }}</td>
                    <td>{{ .Name }}</td>
                    <td>{{ preview .Note }}</td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>

        <!-- Image Gallery Tab -->
        <div class="tab-pane fade" id="gallery" role="tabpanel" aria-labelledby="gallery-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-secondary">Image Gallery</h3>
            </div>
            <div class="row g-3">
                {{ range .plant.Images }}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card">
                        <img
                                src="{{ .ImagePath }}"
                                class="card-img-top thumbnail-img"
                                alt="{{ .ImageDescription }}"
                                data-bs-toggle="modal"
                                data-bs-target="#imageModal"
                                data-image="{{ .ImagePath }}"
                                data-description="{{ .ImageDescription }}"
                                data-date="{{ formatDate .ImageDate }}"
                                data-id="{{ .ID }}"
                        >
                        <div class="card-body text-center">
                            <small class="text-muted">{{ formatDate .ImageDate }}</small>
                        </div>
                    </div>

                </div>
                {{ end }}
            </div>
        </div>
    </div>
</div>

<!-- Upload Images Modal -->
<div class="modal fade" id="uploadImagesModal" tabindex="-1" aria-labelledby="uploadImagesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadImagesModalLabel">Upload Images</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Drag-and-Drop Area -->
                <div id="dropArea" class="border border-primary rounded p-4 text-center mb-3">
                    <p>Drag and drop images here or click to browse</p>
                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                </div>
                <div id="imagePreviewContainer" class="row g-3">
                    <!-- Preview cards for uploaded images will be appended here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="uploadImagesButton">Upload Images</button>
            </div>
        </div>
    </div>
</div>

<!-- Updated Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Full-size image">
                </div>
                <div class="d-none">
                    <img id="originalImageSrc" id="originalImageSrc">
                </div>
                <input type="hidden" id="imageId" >
                <input type="hidden" id="modalDate" >
                <input type="hidden" id="modalStartDate" value="{{ .plant.StartDT | formatDateISO }}" >
                <input type="hidden" id="modalPlantName" value="{{ .plant.Name }}" >
                <div class="mt-3">
                    <div class="row">
                        <!-- Font Selection -->
                        <div class="col-md-6">
                            <label for="fontDropdown">Select Font</label>
                            <select id="fontDropdown" class="form-select">
                                <!-- Dynamically populated -->
                            </select>
                            <p id="fontPreview" class="mt-2">Preview: The quick brown fox</p>
                        </div>
                        <!-- Logo Selection -->
                        <div class="col-md-6">
                            <label for="logoDropdown">Select Logo</label>
                            <select id="logoDropdown" class="form-select">
                                <option value="">None</option>
                                <!-- Dynamically populated -->
                            </select>
                            <img id="logoPreview" src="" class="img-thumbnail mt-2" style="max-width: 100px; display: none;" />
                        </div>
                    </div>
                    <div class="row mt-3">
                        <!-- Text Customization -->
                        <div class="col-md-6">
                            <label for="text1">Top Text</label>
                            <select id="text1Dropdown" class="form-select">

                            </select>
                            <input type="text" id="text1" class="form-control mt-2" placeholder="Custom text" disabled>
                            <label for="text1Corner" class="mt-2">Placement</label>
                            <select id="text1Corner" class="form-select">
                                <option selected value="top-left">Top Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="bottom-right">Bottom Right</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="text2">Bottom Text</label>
                            <select id="text2Dropdown" class="form-select">

                            </select>
                            <input type="text" id="text2" class="form-control mt-2" placeholder="Custom text" disabled>
                            <label for="text2Corner" class="mt-2">Placement</label>
                            <select id="text2Corner" class="form-select">
                                <option value="top-left">Top Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option selected value="bottom-right">Bottom Right</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="textColor">Text Color</label>
                            <input type="color" id="textColor" class="form-control form-control-color" value="#FFFFFF">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button id="decorateImage" class="btn btn-primary">
                        <i class="fa fa-magic"></i> Decorate Image
                    </button>
                </div>
                <!-- Delete Icon -->
                <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                        onclick="confirmDeleteImage()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Link Sensor Modal -->
<div class="modal fade" id="linkSensorModal" tabindex="-1" aria-labelledby="linkSensorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkSensorModalLabel">Link Sensors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="linkSensorForm">
                    <table class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Select</th>
                            <th>Sensor Name</th>
                            <th>Source</th>
                            <th>Device</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{ range .sensors }}
                        <tr>
                            <td>
                                <input
                                        type="checkbox"
                                        class="form-check-input"
                                        name="sensorIds"
                                        value="{{ index . "id" }}"
                                {{ $sensorId := index . "id" }}
                                {{ range $.plant.Sensors }}
                                {{ if eq (toInt $sensorId) .ID }}checked{{ end }}
                                {{ end }}
                                >
                            </td>
                            <td>{{ index . "name" }}</td>
                            <td>{{ index . "source" }}</td>
                            <td>{{ index . "device" }}</td>
                        </tr>
                        {{ end }}

                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary">Link Sensors</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Change Status Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeStatusModalLabel">Update Plant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changeStatusForm">
                    <!-- Status Dropdown -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" required>
                            {{ range .statuses }}
                            <option
                                    {{ if eq .ID $.plant.StatusID }}selected{{ end }}
                                    value="{{ .ID }}">{{ .Status }}</option>
                            {{ end }}
                        </select>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="statusDate" class="form-label">Effective Date</label>
                        <input type="date" class="form-control" id="statusDate" required>
                    </div>

                    <!-- Plant Name -->
                    <div class="mb-3">
                        <label for="plantName" class="form-label">Plant Name</label>
                        <input type="text" class="form-control" id="plantName" value="{{ .plant.Name }}">
                    </div>

                    <!-- Start Date -->
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" value="{{ .plant.StartDT | formatDateISO }}">
                    </div>

                    <!-- Plant Description -->
                    <div class="mb-3">
                        <label for="plantDescription" class="form-label">Plant Description</label>
                        <textarea class="form-control" id="plantDescription" rows="3">{{ .plant.Description }}</textarea>
                    </div>

                    <!-- Plant Strain -->
                    <!-- Strain Dropdown -->
                    <div class="mb-3">
                        <label for="strainSelect" class="form-label">Strain</label>
                        <select class="form-select" id="strainSelect" required>
                            {{ range .strains }}
                            <option
                                    {{ if eq .ID $.plant.StrainID }}selected{{ end }}
                                    value="{{ .ID }}">{{ .Name }} ({{ .Breeder }})</option>
                            {{ end }}
                            <option value="new">Add New Strain</option>
                        </select>
                    </div>

                    <!-- New Strain Inputs -->
                    <div class="mb-3 d-none" id="newStrainInputs">
                        <label for="newStrainName" class="form-label">Strain Name</label>
                        <input type="text" class="form-control" id="newStrainName" placeholder="Enter Strain Name">

                        <!-- Breeder Dropdown -->
                        <div class="mb-3">
                            <label for="breederSelect" class="form-label">Breeder</label>
                            <select class="form-select" id="breederSelect">
                                {{ range .breeders }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                                <option value="new">Add New Breeder</option>
                            </select>
                        </div>

                        <!-- New Breeder Input -->
                        <div class="mb-3 d-none" id="newBreederInput">
                            <label for="newBreederName" class="form-label">New Breeder Name</label>
                            <input type="text" class="form-control" id="newBreederName" placeholder="Enter Breeder Name">
                        </div>
                    </div>

                    <!-- Clone Checkbox -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="cloneCheckbox"
                        {{ if .plant.IsClone }}checked{{ end }}
                        >
                        <label class="form-check-label" for="cloneCheckbox">This plant is a clone</label>
                    </div>

                    <!-- Zone Dropdown -->
                    <div class="mb-3">
                        <label for="zoneSelect" class="form-label">Zone</label>
                        <select class="form-select" id="zoneSelect" required>
                            {{ range .zones }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                            <option value="new">Add New Zone</option>
                        </select>
                    </div>

                    <!-- New Zone Input -->
                    <div class="mb-3 d-none" id="newZoneInput">
                        <label for="newZoneName" class="form-label">New Zone Name</label>
                        <input type="text" class="form-control" id="newZoneName" placeholder="Enter Zone Name">
                    </div>

                    <!-- Plant ID (Hidden Input) -->
                    <input type="hidden" id="plantId" value="{{ .plant.ID }}">

                    <!-- Harvest Weight -->
                    <div class="mb-3">
                        <label for="harvestWeight" class="form-label">Harvest Weight (g)</label>
                        <input type="number" class="form-control" id="harvestWeight" value="{{ .plant.HarvestWeight }}">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Change Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Measurement Modal -->
<div class="modal fade" id="addMeasurementModal" tabindex="-1" aria-labelledby="addMeasurementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMeasurementModalLabel">Add Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMeasurementForm">
                    <!-- Metric Name Dropdown -->
                    <div class="mb-3">
                        <label for="measurementName" class="form-label">Measurement Name</label>
                        <select class="form-select" id="measurementName" required>
                            {{ range .measurements }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <!-- Metric Value Input -->
                    <div class="mb-3">
                        <label for="measurementValue" class="form-label">Measurement Value</label>
                        <input type="number" class="form-control" id="measurementValue" step="any" required>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="measureDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="measureDate" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Measurement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Activity Modal -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-labelledby="addActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addActivityModalLabel">Add Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addActivityForm">
                    <!-- Activity Name Dropdown -->
                    <div class="mb-3">
                        <label for="activityName" class="form-label">Activity Name</label>
                        <select class="form-select" id="activityName" required>
                            {{ range .activities }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <!-- Activity Note Input -->
                    <div class="mb-3">
                        <label for="activityNote" class="form-label">Activity Note</label>
                        <textarea class="form-control" id="activityNote" rows="3"></textarea>
                    </div>

                    <!-- Date Picker -->
                    <div class="mb-3">
                        <label for="activityDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="activityDate" required>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">Add Activity</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Status History Edit Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStatusModalLabel">Edit Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStatusForm">
                    <input type="hidden" id="statusId">
                    <div class="mb-3">
                        <label for="editStatusDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editStatusDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteStatus"><i class="fa-solid fa-trash"></i> Delete Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Measurement Edit Modal -->
<div class="modal fade" id="editMeasurementModal" tabindex="-1" aria-labelledby="editMeasurementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMeasurementModalLabel">Edit Measurement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMeasurementForm">
                    <input type="hidden" id="measurementId">
                    <div class="mb-3">
                        <label for="editMeasurementDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editMeasurementDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMeasurementValue" class="form-label">Value</label>
                        <input type="number" class="form-control" id="editMeasurementValue" step="any" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteMeasurement"><i class="fa-solid fa-trash"></i> Delete Measurement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Activity Edit Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1" aria-labelledby="editActivityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editActivityModalLabel">Edit Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm">
                    <input type="hidden" id="activityId">
                    <div class="mb-3">
                        <label for="editActivityDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editActivityDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editActivityType" class="form-label">Type</label>
                        <select class="form-select" id="editActivityType" required>
                            {{ range .activities }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editActivityNote" class="form-label">Note</label>
                        <textarea class="form-control" id="editActivityNote" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                    <button type="button" class="btn btn-danger" id="deleteActivity"><i class="fa-solid fa-trash"></i> Delete Activity</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("addMeasurementForm");
        const addMeasurementModal = document.getElementById("addMeasurementModal");
        const measurementDateInput = document.getElementById("measureDate");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            measurementDateInput.value = today;
        };

        // Set default date when the modal is shown
        addMeasurementModal.addEventListener("show.bs.modal", setDefaultDate);

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const metricId = document.getElementById("measurementName").value;
            const value = document.getElementById("measurementValue").value;
            const date = measurementDateInput.value;

            // Construct the payload
            const payload = {
                plant_id: parseInt(plantId, 10),
                metric_id: parseInt(metricId, 10),
                value: parseFloat(value),
                date: date,
            };

            // Send POST request to /plantMeasurement
            fetch("/plantMeasurement", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add measurement");
                    }
                    return response.json();
                })
                .then((data) => {
                    // Success: Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addMeasurementModal"));
                    modal.hide();
                    window.location.reload(); // Refresh page to show updated data
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add measurement. Please try again.");
                });
        });
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("addActivityForm");
        const addActivityModal = document.getElementById("addActivityModal");
        const activityDateInput = document.getElementById("activityDate");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            activityDateInput.value = today;
        };

        // Set default date when the modal is shown
        addActivityModal.addEventListener("show.bs.modal", setDefaultDate);

        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const activityId = document.getElementById("activityName").value;
            const activityNote = document.getElementById("activityNote").value;
            const date = activityDateInput.value;

            // Construct the payload
            const payload = {
                plant_id: parseInt(plantId, 10),
                activity_id: parseInt(activityId, 10),
                note: activityNote,
                date: date,
            };

            // Send POST request to /plantActivity
            fetch("/plantActivity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to add activity");
                    }
                    return response.json();
                })
                .then((data) => {
                    // Success: Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addActivityModal"));
                    modal.hide();
                    window.location.reload(); // Refresh page to show updated data
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add activity. Please try again.");
                });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const changeStatusModal = document.getElementById("changeStatusModal");
        const statusDateInput = document.getElementById("statusDate");
        const zoneSelect = document.getElementById("zoneSelect");
        const newZoneInput = document.getElementById("newZoneInput");
        const strainSelect = document.getElementById("strainSelect");
        const newStrainInputs = document.getElementById("newStrainInputs");
        const breederSelect = document.getElementById("breederSelect");
        const newBreederInput = document.getElementById("newBreederInput");
        const newZoneName = document.getElementById("newZoneName");
        const newStrainName = document.getElementById("newStrainName");
        const newBreederName = document.getElementById("newBreederName");
        const harvestWeight = document.getElementById("harvestWeight");

        // Set default date to today
        const setDefaultDate = () => {
            const today = new Date().toISOString().split("T")[0];
            statusDateInput.value = today;
        };

        // Reset Zone Selection
        const resetZoneSelection = () => {
            zoneSelect.disabled = false;
            zoneSelect.value = "";
            newZoneInput.classList.add("d-none");
        };

        // Reset Strain Selection
        const resetStrainSelection = () => {
            strainSelect.value = "";
            newStrainInputs.classList.add("d-none");
            resetBreederSelection();
        };

        // Reset Breeder Selection
        const resetBreederSelection = () => {
            breederSelect.value = "";
            newBreederInput.classList.add("d-none");
        };


        // Set default date when the modal is shown
        changeStatusModal.addEventListener("show.bs.modal", () => {
            setDefaultDate();
        });

        // Show/Hide New Zone Input
        zoneSelect.addEventListener("change", () => {
            if (zoneSelect.value === "new") {
                newZoneInput.classList.remove("d-none");
            } else {
                newZoneInput.classList.add("d-none");
            }
        });

        // Show/Hide New Strain Inputs
        strainSelect.addEventListener("change", () => {
            if (strainSelect.value === "new") {
                newStrainInputs.classList.remove("d-none");
            } else {
                newStrainInputs.classList.add("d-none");
            }
        });

        // Show/Hide New Breeder Input
        breederSelect.addEventListener("change", () => {
            if (breederSelect.value === "new") {
                newBreederInput.classList.remove("d-none");
            } else {
                newBreederInput.classList.add("d-none");
            }
        });

        // Handle form submission
        const changeStatusForm = document.getElementById("changeStatusForm");
        changeStatusForm.addEventListener("submit", (e) => {
            e.preventDefault();

            // Gather form data
            const plantId = document.getElementById("plantId").value;
            const status = document.getElementById("status").value;
            const date = statusDateInput.value;
            const startDate = document.getElementById("startDate").value;

            const payload = {
                plant_id: parseInt(plantId, 10),
                plant_name: document.getElementById("plantName").value,
                plant_description: document.getElementById("plantDescription").value,
                status_id: parseInt(status, 10),
                date: date,
                zone_id: parseInt(zoneSelect.value, 10),
                new_zone: newZoneName.value,
                strain_id: parseInt(strainSelect.value, 10),
                new_strain: strainSelect.value === "new" ? {
                    name: newStrainName.value,
                    breeder_id: breederSelect.value === "new" ? null : parseInt(breederSelect.value, 10),
                    new_breeder: breederSelect.value === "new" ? newBreederName.value : null
                } : null,
                clone: document.getElementById("cloneCheckbox").checked,
                start_date: startDate,
                harvest_weight: parseFloat(harvestWeight.value),
            };

            //alert(JSON.stringify(payload));

            // Send POST request to change status
            fetch("/plant", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to change status");
                    }
                    return response.json();
                })
                .then(data => {
                    //alert("Status changed successfully!");
                    location.reload(); // Reload the page to reflect changes
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to change status. Please try again.");
                });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Handle Linking Sensors
        const linkSensorForm = document.getElementById("linkSensorForm");
        linkSensorForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const plantId = document.getElementById("plantId").value;
            const formData = new FormData(linkSensorForm);
            const sensorIds = formData.getAll("sensorIds").map(id => parseInt(id, 10));
            const payload = {
                plant_id: plantId,
                sensor_ids: sensorIds
        };

            fetch("/plant/link-sensors", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to link sensors");
                    //alert("Sensors linked successfully!");
                    location.reload();
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to link sensors. Please try again.");
                });
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editMeasurementModal = new bootstrap.Modal(document.getElementById("editMeasurementModal"));
        const measurementForm = document.getElementById("editMeasurementForm");
        const deleteMeasurementButton = document.getElementById("deleteMeasurement");

        document.querySelectorAll(".measurement-row").forEach(row => {
            row.addEventListener("click", () => {
                const measurementData = JSON.parse(row.getAttribute("data-measurement"));

                document.getElementById("measurementId").value = measurementData.id;
                const formattedDate = measurementData.date.split("T")[0];
                document.getElementById("editMeasurementDate").value = formattedDate;
                document.getElementById("editMeasurementValue").value = measurementData.value;

                editMeasurementModal.show();
            });
        });

        measurementForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("measurementId").value, 10),
                date: document.getElementById("editMeasurementDate").value,
                value: parseFloat(document.getElementById("editMeasurementValue").value),
            };

            fetch("/plantMeasurement/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update measurement"));
        });

        deleteMeasurementButton.addEventListener("click", () => {
            const measurementId = document.getElementById("measurementId").value;

            if (confirm("Are you sure you want to delete this measurement?")) {
                fetch(`/plantMeasurement/delete/${measurementId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete measurement"));
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editStatusModal = new bootstrap.Modal(document.getElementById("editStatusModal"));
        const statusForm = document.getElementById("editStatusForm");
        const deleteStatusButton = document.getElementById("deleteStatus");

        document.querySelectorAll(".status-row").forEach(row => {
            row.addEventListener("click", () => {
                const statusData = JSON.parse(row.getAttribute("data-status"));

                document.getElementById("statusId").value = statusData.id;
                const formattedDate = statusData.date.split("T")[0];
                document.getElementById("editStatusDate").value = formattedDate;

                editStatusModal.show();
            });
        });

        statusForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("statusId").value, 10),
                date: document.getElementById("editStatusDate").value,
            };

            fetch("/plantStatus/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update status history"));
        });

        deleteStatusButton.addEventListener("click", () => {
            const statusId = document.getElementById("statusId").value;

            if (confirm("Are you sure you want to delete this status?")) {
                fetch(`/plantStatus/delete/${statusId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete status history"));
            }
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const editActivityModal = new bootstrap.Modal(document.getElementById("editActivityModal"));
        const activityForm = document.getElementById("editActivityForm");
        const deleteActivityButton = document.getElementById("deleteActivity");

        document.querySelectorAll(".activity-row").forEach(row => {
            row.addEventListener("click", () => {
                const activityData = JSON.parse(row.getAttribute("data-activity"));

                document.getElementById("activityId").value = activityData.id;
                const formattedDate = activityData.date.split("T")[0];
                document.getElementById("editActivityDate").value = formattedDate;
                document.getElementById("editActivityType").value = activityData.activity_id;
                document.getElementById("editActivityNote").value = activityData.note;

                editActivityModal.show();
            });
        });

        activityForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const payload = {
                id: parseInt(document.getElementById("activityId").value, 10),
                date: document.getElementById("editActivityDate").value,
                activity_id: parseInt(document.getElementById("editActivityType").value, 10),
                note: document.getElementById("editActivityNote").value,
            };

            fetch("/plantActivity/edit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(() => location.reload())
                .catch(err => alert("Failed to update activity"));
        });

        deleteActivityButton.addEventListener("click", () => {
            const activityId = document.getElementById("activityId").value;

            if (confirm("Are you sure you want to delete this activity?")) {
                fetch(`/plantActivity/delete/${activityId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.reload())
                    .catch(err => alert("Failed to delete activity"));
            }
        });

        deletePlantButton.addEventListener("click", () => {
            const plantId = document.getElementById("plantId").value;

            if (confirm("Are you sure you want to delete this plant?")) {
                fetch(`/plant/delete/${plantId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => location.href = "/plants")
                    .catch(err => alert("Failed to delete plant"));
            }
        })
    });

    document.addEventListener("DOMContentLoaded", () => {
        const imageModal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");
        const originalImageSrc = document.getElementById("originalImageSrc");
        const modalDescription = document.getElementById("modalDescription");
        const modalDateInput = document.getElementById("modalDate");
        const imageIdInput = document.getElementById("imageId");
        const modalStartDate = document.getElementById("modalStartDate");
        const text1dropdown = document.getElementById("text1Dropdown");
        const text2dropdown = document.getElementById("text2Dropdown");

        document.querySelectorAll(".thumbnail-img").forEach((img) => {
            img.addEventListener("click", () => {
                modalImage.src = img.dataset.image;
                originalImageSrc.src = img.dataset.image;
                //modalDescription.textContent = img.dataset.description;
                modalDateInput.value = img.dataset.date;
                imageIdInput.value = img.dataset.id;

                // Calculate Current Days from plant start date and modal date
                const plantStartDate = new Date(modalStartDate.value);
                const modalDate = new Date(img.dataset.date);
                const diffTime = Math.abs(modalDate - plantStartDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffWeeks = Math.floor(diffDays / 7);
                const strainName = document.getElementById("strainName").value;
                const breederName = document.getElementById("breederName").value;
                const plantName = document.getElementById("modalPlantName").value;
                console.log("Start Date: " + plantStartDate + " Modal Date: " + modalDate + " Diff Days: " + diffDays + " Diff Weeks: " + diffWeeks);

                // clear text1dropdown
                for (let i = text1dropdown.options.length - 1; i >= 0; i--) {
                    text1dropdown.remove(i);
                }
                //clear text2dropdown
                for (let i = text2dropdown.options.length - 1; i >= 0; i--) {
                    text2dropdown.remove(i);
                }
                /*
                <option selected value="{{ .plant.StrainName }}">Strain Name</option>
                <option value="{{ .plant.BreederName }}">Breeder Name</option>
                <option value="{{ .plant.Name }}">Plant Name</option>
                <option value="Day {{ .plant.CurrentDay }}">Current Day</option>
                <option value="Week {{ .plant.CurrentWeek }}">Current Week</option>
                <option value="Custom">Custom</option>
                 */
                text1dropdown.appendChild(new Option(strainName, strainName, true, true));
                text1dropdown.appendChild(new Option(breederName, breederName));
                text1dropdown.appendChild(new Option(plantName, plantName));
                text1dropdown.appendChild(new Option("Day " + diffDays, "Day " + diffDays));
                text1dropdown.appendChild(new Option("Week " + diffWeeks, "Week " + diffWeeks));
                text1dropdown.appendChild(new Option("Custom", "Custom"));

                text2dropdown.appendChild(new Option(strainName, strainName));
                text2dropdown.appendChild(new Option(breederName, breederName));
                text2dropdown.appendChild(new Option(plantName, plantName));
                text2dropdown.appendChild(new Option("Day " + diffDays, "Day " + diffDays, true, true));
                text2dropdown.appendChild(new Option("Week " + diffWeeks, "Week " + diffWeeks));
                text2dropdown.appendChild(new Option("Custom", "Custom"));

            });
        });
    });

</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const dropArea = document.getElementById("dropArea");
        const imageInput = document.getElementById("imageInput");
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        const uploadImagesButton = document.getElementById("uploadImagesButton");

        let imagesToUpload = [];

        // Handle drag-and-drop events
        ["dragenter", "dragover"].forEach(eventType => {
            dropArea.addEventListener(eventType, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.add("border-success");
            });
        });

        ["dragleave", "drop"].forEach(eventType => {
            dropArea.addEventListener(eventType, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropArea.classList.remove("border-success");
            });
        });

        // Handle drop event
        dropArea.addEventListener("drop", (e) => {
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // Handle click to browse
        dropArea.addEventListener("click", () => {
            imageInput.click();
        });

        imageInput.addEventListener("change", () => {
            const files = Array.from(imageInput.files);
            handleFiles(files);
        });

        // Process selected files
        function handleFiles(files) {
            files.forEach((file) => {
                if (!file.type.startsWith("image/")) {
                    alert("Only image files are allowed!");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = e.target.result;

                    // Read EXIF metadata
                    EXIF.getData(file, function () {
                        let imageDate = new Date().toISOString().split("T")[0]; // Default to current date

                        // Try to get the DateTimeOriginal tag from EXIF
                        const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                        if (exifDate) {
                            const parsedDate = parseExifDate(exifDate);
                            if (parsedDate) imageDate = parsedDate;
                        }

                        addImagePreview(fileData, file, imageDate);
                    });
                };

                reader.readAsDataURL(file);
                imagesToUpload.push(file);
            });
        }

// Parse EXIF DateTimeOriginal format "YYYY:MM:DD HH:MM:SS" into "YYYY-MM-DD"
        function parseExifDate(exifDate) {
            try {
                const parts = exifDate.split(" ")[0].split(":"); // Split on space, then ":"
                if (parts.length === 3) {
                    return `${parts[0]}-${parts[1]}-${parts[2]}`;
                }
            } catch (error) {
                console.error("Error parsing EXIF date:", error);
            }
            return null;
        }

// Add image preview with default or EXIF date
        function addImagePreview(src, file, imageDate) {
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 col-lg-4";

            const card = `
        <div class="card">
            <img src="${src}" class="card-img-top" alt="Preview">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control description" placeholder="Enter description">
                </div>
                <div class="mb-3">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control image-date" value="${imageDate}">
                </div>
            </div>
        </div>
    `;

            col.innerHTML = card;
            imagePreviewContainer.appendChild(col);
        }


        // Handle upload
        uploadImagesButton.addEventListener("click", () => {
            const formData = new FormData();

            // Collect data for each image
            document.querySelectorAll("#imagePreviewContainer .card").forEach((card, index) => {
                const description = card.querySelector(".description").value;
                const date = card.querySelector(".image-date").value;

                // Append the file with a simple key
                formData.append("images[]", imagesToUpload[index]);
                formData.append(`descriptions[]`, description);
                formData.append(`dates[]`, date);
            });

            const plantId = document.getElementById("plantId").value;
            fetch(`/plant/${plantId}/images/upload`, {
                method: "POST",
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to upload images");
                    }
                    return response.json();
                })
                .then((data) => {
                    //alert("Images uploaded successfully!");
                    location.reload();
                })
                .catch((error) => {
                    console.error("Error uploading images:", error);
                    alert("An error occurred while uploading images.");
                });
        });

    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const fontDropdown = document.getElementById("fontDropdown");
        const fontPreview = document.getElementById("fontPreview");
        const logoDropdown = document.getElementById("logoDropdown");
        const logoPreview = document.getElementById("logoPreview");
        const decorateImageButton = document.getElementById("decorateImage");
        const modalImage = document.getElementById("modalImage");
        const originalImageSrc = document.getElementById("originalImageSrc");
        const text1Input = document.getElementById("text1");
        const text2Input = document.getElementById("text2");
        const text1Dropdown = document.getElementById("text1Dropdown");
        const text2Dropdown = document.getElementById("text2Dropdown");

        // Load fonts
        fetch("/listFonts")
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    data.fonts.forEach((font) => {
                        const fontName = font.split("/").pop().replace(".ttf", "");
                        const option = document.createElement("option");
                        option.value = font;
                        option.textContent = fontName;
                        fontDropdown.appendChild(option);
                    });

                    const selectedFont = fontDropdown.value;
                    if (selectedFont) {
                        const fontName = selectedFont.split("/").pop().replace(".ttf", "");
                        const fontUrl = `/${selectedFont}`;

                        // Add @font-face rule dynamically
                        const style = document.createElement("style");
                        style.innerHTML = `
                @font-face {
                    font-family: '${fontName}';
                    src: url('${fontUrl}');
                }
            `;
                        document.head.appendChild(style);

                        // Apply the new font to the preview
                        fontPreview.style.fontFamily = fontName;
                    }

                }
            });

        // Load logos
        fetch("/listLogos")
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    data.logos.forEach((logo) => {
                        const option = document.createElement("option");
                        option.value = logo;
                        option.textContent = logo.split("/").pop();
                        logoDropdown.appendChild(option);
                    });
                }
            });

        // Font preview
        fontDropdown.addEventListener("change", () => {
            const selectedFont = fontDropdown.value;
            if (selectedFont) {
                const fontName = selectedFont.split("/").pop().replace(".ttf", "");
                const fontUrl = `/${selectedFont}`;

                // Add @font-face rule dynamically
                const style = document.createElement("style");
                style.innerHTML = `
                @font-face {
                    font-family: '${fontName}';
                    src: url('${fontUrl}');
                }
            `;
                document.head.appendChild(style);

                // Apply the new font to the preview
                fontPreview.style.fontFamily = fontName;
            }
        });

        // Logo preview
        logoDropdown.addEventListener("change", () => {
            if (logoDropdown.value) {
                logoPreview.src = `/${logoDropdown.value}`;
                logoPreview.style.display = "block";
            } else {
                logoPreview.style.display = "none";
            }
        });

        // Enable custom input fields based on dropdown selection
        [text1Dropdown, text2Dropdown].forEach((dropdown, index) => {
            dropdown.addEventListener("change", () => {
                const input = index === 0 ? text1Input : text2Input;
                input.disabled = dropdown.value !== "Custom";
            });
        });

        decorateImageButton.addEventListener("click", () => {
            const fullImagePath = originalImageSrc.src;
            const imagePath = new URL(fullImagePath).pathname.replace(/^\//, "");
            const text1Dropdown = document.getElementById("text1Dropdown");
            const text2Dropdown = document.getElementById("text2Dropdown");
            const text1Input = document.getElementById("text1");
            const text2Input = document.getElementById("text2");
            const text1 = text1Dropdown.value === "Custom" ? text1Input.value : text1Dropdown.value;
            const text2 = text2Dropdown.value === "Custom" ? text2Input.value : text2Dropdown.value;
            const logo = logoDropdown.value;
            const font = fontDropdown.value;
            const textColor = document.getElementById("textColor").value;
            const text1Corner = document.getElementById("text1Corner").value;
            const text2Corner = document.getElementById("text2Corner").value;

            // Add a spinner overlay
            const modal = document.getElementById("imageModal");
            const spinnerOverlay = document.createElement("div");
            spinnerOverlay.id = "spinnerOverlay";
            spinnerOverlay.innerHTML = `<div class="spinner-border text-primary" role="status"></div>`;
            modal.appendChild(spinnerOverlay);

            // Send POST request
            fetch("/decorateImage", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    imagePath,
                    text1,
                    text2,
                    text1Corner,
                    text2Corner,
                    logo,
                    font,
                    textColor,
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        modalImage.src = "../" + data.outputPath + "?" + new Date().getTime();
                    } else {
                        alert("Failed to decorate image: " + data.error);
                    }
                })
                .catch((error) => console.error("Error decorating image:", error))
                .finally(() => {
                    document.getElementById("spinnerOverlay").remove();
                });
        });
    });

    function confirmDeleteImage() {
        const imageId = document.getElementById("imageId").value;
        if (confirm("Are you sure you want to delete this image?")) {
            fetch(`/plant/images/${imageId}/delete`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to delete image");
                    }
                    return response.json();
                })
                .then((data) => {
                    alert("Image deleted successfully!");
                    // Reload the page to reflect changes
                    location.reload();
                })
                .catch((error) => {
                    console.error("Error deleting image:", error);
                    alert("An error occurred while deleting the image.");
                });
        }
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>
<!--Embed the footer.html template at this location-->
{{ template "layouts/footer.html" .}}

{{ end }}